<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Wush筆記]]></title>
  <link href="http://wush978.github.com/atom.xml" rel="self"/>
  <link href="http://wush978.github.com/"/>
  <updated>2012-12-03T17:25:58+08:00</updated>
  <id>http://wush978.github.com/</id>
  <author>
    <name><![CDATA[Wush978]]></name>
    <email><![CDATA[wush.978@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[unicode escape in R]]></title>
    <link href="http://wush978.github.com/blog/2012/12/03/unicode-escape-in-r/"/>
    <updated>2012-12-03T17:14:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/12/03/unicode-escape-in-r</id>
    <content type="html"><![CDATA[<h1>簡介</h1>

<p>最近需要分析中文資料，就遇到了unicode escape的問題。</p>

<p>除了抓下來的資料問題外，就是轉JSON的時候也會跑出來</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>library<span class="p">(</span>rjson<span class="p">)</span>
</span><span class='line'>toJSON<span class="p">(</span><span class="s">&quot;測試&quot;</span><span class="p">)</span>
</span><span class='line'>toJSON<span class="p">(</span><span class="s">&quot;測試&quot;</span><span class="p">,</span> <span class="s">&quot;R&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>&gt; library<span class="o">(</span>rjson<span class="o">)</span>
</span><span class='line'>&gt; toJSON<span class="o">(</span><span class="s2">&quot;測試&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> <span class="s2">&quot;\&quot;\\u6e2c\\u8a66\&quot;&quot;</span>
</span><span class='line'>&gt; toJSON<span class="o">(</span><span class="s2">&quot;測試&quot;</span>, <span class="s2">&quot;R&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> <span class="s2">&quot;\&quot;測試\&quot;&quot;</span>
</span><span class='line'>&gt;
</span></code></pre></td></tr></table></div></figure>


<p>中間的<code>\u6e2c\u8a66</code>就是unicode escape</p>

<h1>解法原理</h1>

<p>上面的<code>\u6e2c</code>中，<code>\u</code>是header，<code>6e2c</code>是<strong>UTF16BE</strong>編碼的hex code。</p>

<p>了解這點之後，就很容易自己做出解決方法：</p>

<ul>
<li>利用regular expression(如<code>gregexpr</code>)定位<code>\\u[0-9a-f]{4,4}</code></li>
<li>利用iconv把後面的兩個byte從<strong>UTF16BE</strong>轉換回<strong>UTF8</strong></li>
</ul>


<h1>很弱的實作</h1>

<p>但是我在R裏面沒有找到原生的hex轉string的函數，最後就自己刻了兩個函數，效能很差。</p>

<ul>
<li><a href="git://gist.github.com/4193275.git"><code>hex2str</code></a></li>
<li><a href="git://gist.github.com/4193405.git"><code>remove_unicode_escape</code></a></li>
</ul>


<p>但是原理知道了，所以之後我有空可能刻個C++的解決方案。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[R package installation tips on Ubuntu]]></title>
    <link href="http://wush978.github.com/blog/2012/09/24/r-package-installation-tips-on-ubuntu/"/>
    <updated>2012-09-24T13:18:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/09/24/r-package-installation-tips-on-ubuntu</id>
    <content type="html"><![CDATA[<h1>rgl</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo apt-get install r-cran-rgl
</span></code></pre></td></tr></table></div></figure>


<h1>RBGL, R interface to the Boost Graph Library</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'><span class="c1">#! /usr/bin/R</span>
</span><span class='line'>source<span class="p">(</span><span class="s">&quot;http://bioconductor.org/biocLite.R&quot;</span><span class="p">)</span>
</span><span class='line'>biocLite<span class="p">(</span><span class="s">&quot;RBGL&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Initialize PostgreSQL in Ubuntu 12.04]]></title>
    <link href="http://wush978.github.com/blog/2012/08/30/initialize-postgresql/"/>
    <updated>2012-08-30T13:41:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/08/30/initialize-postgresql</id>
    <content type="html"><![CDATA[<h1>Install</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo apt-get install postgresql
</span></code></pre></td></tr></table></div></figure>


<h1>Configure</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo -u postgres createuser -D -P ruser
</span><span class='line'>sudo -u postgres createdb -O ruser ruserdb
</span></code></pre></td></tr></table></div></figure>


<p>Edit <code>/etc/postgresql/9.1/main/pg_hba.conf</code>.</p>

<p>Change this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">local   </span>all             all                                     peer
</span></code></pre></td></tr></table></div></figure>


<p>to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">local   </span>all             all                                     md5
</span></code></pre></td></tr></table></div></figure>


<p>Restart service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo service postgresql restart
</span></code></pre></td></tr></table></div></figure>


<h1>Reference</h1>

<ul>
<li><a href="http://blog.deliciousrobots.com/2011/12/13/get-postgres-working-on-ubuntu-or-linux-mint/">GET POSTGRES WORKING ON UBUNTU OR LINUX MINT</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Benchmark of Saving and Loading R Objects]]></title>
    <link href="http://wush978.github.com/blog/2012/08/30/benchmark-of-saving-and-loading-r-objects/"/>
    <updated>2012-08-30T12:48:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/08/30/benchmark-of-saving-and-loading-r-objects</id>
    <content type="html"><![CDATA[<h1>Introduction</h1>

<p>To compare the speed of saving and loading R objects to and from MongoDB
with or without serialization.</p>

<h1>Environment</h1>

<ul>
<li>OpenVZ with Ubuntu 12.04, i7-2600 CPU @ 3.4GHz, 2 processors, 4G RAM</li>
<li>Local MongoDB</li>
<li>Local PostgreSQL</li>
<li>R 1.14.1</li>
<li>rmongodb 1.0.3</li>
<li>RPostgreSQL 0.3-2</li>
</ul>


<h1>Initialize</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo apt-get install mongodb
</span></code></pre></td></tr></table></div></figure>


<h2>R</h2>

<figure class='code'><figcaption><span>install libpq-dev</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo apt-get install libpq-dev
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>install R packages</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>install.packages<span class="p">(</span><span class="s">&quot;rmongodb&quot;</span><span class="p">)</span>
</span><span class='line'>install.packages<span class="p">(</span><span class="s">&quot;RPostgreSQL&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Benchmark</h1>

<figure class='code'><figcaption><span>Test saving object serialized or not</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'><span class="p">{</span> <span class="c1"># loading package</span>
</span><span class='line'>  library<span class="p">(</span>rmongodb<span class="p">)</span>
</span><span class='line'>  mongo <span class="o">&lt;-</span> mongo.create<span class="p">()</span>
</span><span class='line'>  <span class="kr">if</span> <span class="p">(</span>!mongo.is.connected<span class="p">(</span>mongo<span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    stop<span class="p">(</span><span class="s">&quot;disconnected&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>save1 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>a<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">for</span><span class="p">(</span>i in <span class="m">1</span>:repeat.time<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    b <span class="o">&lt;-</span> mongo.bson.from.list<span class="p">(</span>list<span class="p">(</span>Rdata <span class="o">=</span> a<span class="p">))</span>
</span><span class='line'>    mongo.insert<span class="p">(</span>mongo<span class="p">,</span> <span class="s">&quot;test.save1&quot;</span><span class="p">,</span> b<span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>load1 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  result <span class="o">&lt;-</span> list<span class="p">()</span>
</span><span class='line'>  length<span class="p">(</span>result<span class="p">)</span> <span class="o">&lt;-</span> repeat.time
</span><span class='line'>  cursor <span class="o">&lt;-</span> mongo.find<span class="p">(</span>mongo<span class="p">,</span> <span class="s">&quot;test.save1&quot;</span><span class="p">)</span>
</span><span class='line'>  index <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  <span class="kr">while</span><span class="p">(</span>mongo.cursor.next<span class="p">(</span>cursor<span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    result<span class="p">[[</span>index<span class="p">]]</span> <span class="o">&lt;-</span> mongo.bson.to.list<span class="p">(</span>mongo.cursor.value<span class="p">(</span>cursor<span class="p">))</span>
</span><span class='line'>    index <span class="o">&lt;-</span> index <span class="o">+</span> <span class="m">1</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  result
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>save2 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>a<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">for</span><span class="p">(</span>i in <span class="m">1</span>:repeat.time<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    buf <span class="o">&lt;-</span> mongo.bson.buffer.create<span class="p">()</span>
</span><span class='line'>    mongo.bson.buffer.append<span class="p">(</span>buf<span class="p">,</span> <span class="s">&quot;Rdata&quot;</span><span class="p">,</span> serialize<span class="p">(</span>a<span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">))</span>
</span><span class='line'>    mongo.insert<span class="p">(</span>mongo<span class="p">,</span> <span class="s">&quot;test.save2&quot;</span><span class="p">,</span> mongo.bson.from.buffer<span class="p">(</span>buf<span class="p">))</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>load2 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  result <span class="o">&lt;-</span> list<span class="p">()</span>
</span><span class='line'>  length<span class="p">(</span>result<span class="p">)</span> <span class="o">&lt;-</span> repeat.time
</span><span class='line'>  cursor <span class="o">&lt;-</span> mongo.find<span class="p">(</span>mongo<span class="p">,</span> <span class="s">&quot;test.save2&quot;</span><span class="p">)</span>
</span><span class='line'>  index <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  <span class="kr">while</span><span class="p">(</span>mongo.cursor.next<span class="p">(</span>cursor<span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    result<span class="p">[[</span>index<span class="p">]]</span> <span class="o">&lt;-</span> unserialize<span class="p">(</span>mongo.bson.value<span class="p">(</span>mongo.cursor.value<span class="p">(</span>cursor<span class="p">),</span> <span class="s">&quot;Rdata&quot;</span><span class="p">))</span>
</span><span class='line'>    index <span class="o">&lt;-</span> index <span class="o">+</span> <span class="m">1</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  result
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>repeat.time <span class="o">&lt;-</span> <span class="m">1000</span>
</span><span class='line'>mongo.drop.database<span class="p">(</span>mongo<span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">)</span>
</span><span class='line'>a <span class="o">&lt;-</span> matrix<span class="p">(</span>rnorm<span class="p">(</span><span class="m">100</span><span class="o">^</span><span class="m">2</span><span class="p">),</span> <span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
</span><span class='line'>system.time<span class="p">({</span> <span class="c1">#direct way</span>
</span><span class='line'>  print<span class="p">(</span><span class="s">&quot;directly save and load&quot;</span><span class="p">)</span>
</span><span class='line'>  save1<span class="p">(</span>a<span class="p">)</span>
</span><span class='line'>  a.result <span class="o">&lt;-</span> load1<span class="p">()</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>system.time<span class="p">({</span> <span class="c1">#serialized way</span>
</span><span class='line'>  print<span class="p">(</span><span class="s">&quot;serialized before save and load&quot;</span><span class="p">)</span>
</span><span class='line'>  save2<span class="p">(</span>a<span class="p">)</span>
</span><span class='line'>  a.result2 <span class="o">&lt;-</span> load2<span class="p">()</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>I tested many times and notice that the results are very unstable, and
I guess that the serialized way is faster a little bit.</p>

<p>I paste some results here:</p>

<figure class='code'><figcaption><span>Test saving object serialized or not</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.226</span>   <span class="m">0.083</span>   <span class="m">4.221</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.746</span>   <span class="m">0.095</span>   <span class="m">3.578</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.227</span>   <span class="m">0.090</span>   <span class="m">3.981</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.771</span>   <span class="m">0.106</span>   <span class="m">3.327</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.232</span>   <span class="m">0.104</span>   <span class="m">3.808</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.760</span>   <span class="m">0.110</span>   <span class="m">3.289</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.303</span>   <span class="m">0.078</span>   <span class="m">3.827</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.763</span>   <span class="m">0.109</span>   <span class="m">3.413</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.237</span>   <span class="m">0.089</span>   <span class="m">3.834</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.773</span>   <span class="m">0.091</span>   <span class="m">3.458</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.247</span>   <span class="m">0.114</span>   <span class="m">3.970</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.781</span>   <span class="m">0.110</span>   <span class="m">3.738</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.331</span>   <span class="m">0.142</span>   <span class="m">4.329</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.753</span>   <span class="m">0.098</span>   <span class="m">3.202</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.217</span>   <span class="m">0.090</span>   <span class="m">3.766</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.737</span>   <span class="m">0.097</span>   <span class="m">5.339</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.231</span>   <span class="m">0.103</span>   <span class="m">3.875</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.751</span>   <span class="m">0.105</span>   <span class="m">3.377</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.202</span>   <span class="m">0.085</span>   <span class="m">6.935</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.752</span>   <span class="m">0.082</span>   <span class="m">3.996</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[我喜歡使用虛擬化系統]]></title>
    <link href="http://wush978.github.com/blog/2012/08/24/pros-and-cons-of-virtualized-system/"/>
    <updated>2012-08-24T11:01:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/08/24/pros-and-cons-of-virtualized-system</id>
    <content type="html"><![CDATA[<p>之前我因為工作的關係, 需要使用虛擬化系統來跑測試。</p>

<p>這陣子在架了Proxmox的Virtualization Cluster後覺得這種系統在跑科學模擬上真是太方便，理由如下：</p>

<ul>
<li>環境管理: 我可以對整台機器的環境進行備份、還原和複製。</li>
<li>穩定: 虛擬機器內再怎麼當機怎麼毀滅, 幾乎不會影響到整台機器。所以我不用跑到實驗室去重開，頂多進入Proxmox主控台去重開虛擬機器即可。</li>
</ul>


<p>而使用Proxmox的理由則是：</p>

<ul>
<li>Free</li>
<li>我熟悉ubuntu/debian system</li>
</ul>


<p>當然這樣做也是有一些缺點：</p>

<ul>
<li>學習曲線: 我發現在這種東西的學習上, 我似乎比一般人還敏感一點, 所以我可以接受比較陡峭的學習曲線。</li>
<li>效能: 這點我還沒有空去實際測試。但是虛擬機器正常來說效能是會比較慢的。以目前我的經驗是，使用OpenVZ的虛擬化技術上並沒有感受到特別的效能損失。</li>
</ul>


<p>有興趣或有類似需求或的朋友可以參考看看</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RcppArmadillo]]></title>
    <link href="http://wush978.github.com/blog/2012/08/21/rcpparmadillo/"/>
    <updated>2012-08-21T20:08:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/08/21/rcpparmadillo</id>
    <content type="html"><![CDATA[<h1>Inroduction</h1>

<p>Recently I am exploring the linear algebra features provided in <a href="http://arma.sourceforge.net/">Armadillo</a> through <a href="http://dirk.eddelbuettel.com/code/rcpp.armadillo.html">RcppArmadillo</a>.</p>

<p>Here is the note for myself.</p>

<p>Note these functions are only my understanding of these operators and methods. I didn&#8217;t check the source code of Armadillo and RcppArmadillo.</p>

<h1>Basic Elements and Methods</h1>

<figure class='code'><figcaption><span>mat</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">a</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span> <span class="c1">// Initialize a 5 x 5 matrix.</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// fill it with 0</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">n_rows</span><span class="p">;</span>    <span class="c1">//!&lt; number of rows in the matrix (read-only)</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">n_cols</span><span class="p">;</span>    <span class="c1">//!&lt; number of columns in the matrix (read-only)</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">n_elem</span><span class="p">;</span>    <span class="c1">//!&lt; number of elements in the matrix (read-only)</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">vec_state</span><span class="p">;</span> <span class="c1">//!&lt; 0: matrix layout; 1: column vector layout; 2: row vector layout</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">mem</span><span class="p">;</span>         <span class="c1">//!&lt; pointer to memory used by the matrix (memory is read-only)</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">min</span><span class="p">();</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">max</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Feature</h1>

<h2>Matrix Multiplication</h2>

<figure class='code'><figcaption><span>Matrix Multiplication</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="k">operator</span><span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">y</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Transpose</h2>

<figure class='code'><figcaption><span>Transpose</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">arma</span><span class="o">::</span><span class="n">trans</span><span class="p">(</span><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Methods of class arma::mat</span>
</span><span class='line'><span class="c1">// x.t() = arma::trans(x)</span>
</span><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">::</span><span class="n">t</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Inverse</h2>

<figure class='code'><figcaption><span>Inverse</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">arma</span><span class="o">::</span><span class="n">pinv</span><span class="p">(</span><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Sum of Square</h2>

<figure class='code'><figcaption><span>Sum of Square</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kr">inline</span> <span class="kt">double</span> <span class="n">sumOfSquare</span><span class="p">(</span><span class="n">arma</span><span class="o">::</span><span class="n">vec</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">inner_product</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">x</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">x</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Diagonal Vector</h2>

<figure class='code'><figcaption><span>Diagonal Vector</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">colvec</span> <span class="n">arma</span><span class="o">::</span><span class="n">diagvec</span><span class="p">(</span><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Linear Regression</h2>

<figure class='code'><figcaption><span>Linear Regression</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * @param X    the explanatory variables</span>
</span><span class='line'><span class="cm"> * @param y    the response variable</span>
</span><span class='line'><span class="cm"> * @return     the vector of regression coefficients</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">colvec</span> <span class="n">arma</span><span class="o">::</span><span class="n">solve</span><span class="p">(</span><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">X</span><span class="p">,</span> <span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">vec</span><span class="o">&amp;</span> <span class="n">y</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Residuals</span>
</span><span class='line'><span class="n">arma</span><span class="o">::</span><span class="n">colvec</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">X</span> <span class="o">*</span> <span class="n">coef</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Residual Sum of Square</span>
</span><span class='line'><span class="kt">double</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">sumOfSquare</span><span class="p">(</span><span class="n">residuals</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Std of Coef.</span>
</span><span class='line'><span class="n">arma</span><span class="o">::</span><span class="n">colvec</span> <span class="n">sderr</span> <span class="o">=</span> <span class="n">arma</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2</span> <span class="o">*</span>
</span><span class='line'>  <span class="n">arma</span><span class="o">::</span><span class="n">diagvec</span><span class="p">(</span><span class="n">arma</span><span class="o">::</span><span class="n">pinv</span><span class="p">(</span><span class="n">arma</span><span class="o">::</span><span class="n">trans</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="n">X</span><span class="p">)));</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Proxmox &amp; R cluster]]></title>
    <link href="http://wush978.github.com/blog/2012/08/16/proxmox-and-r-cluster/"/>
    <updated>2012-08-16T11:57:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/08/16/proxmox-and-r-cluster</id>
    <content type="html"><![CDATA[<p>Here I&#8217;ll show how to set up my parallel computing environment of R.</p>

<h1>Introduction</h1>

<p>As far as I know, the virtualization for linux with <a href="http://wiki.openvz.org/Main_Page">OpenVZ</a> does not loss too many computation efficiency.
Moreover, it provides a simple way to <em>copy</em> whole computation environment from one machine to another.
The consistency of the environment reduces the difficulty of setting MPI between machines, so I decide
to build my R cluster under Proxmox, which is an easy to use open source virtualization platform.</p>

<h1>Environment</h1>

<p>OS:</p>

<ul>
<li>Host OS: <a href="http://www.proxmox.com/">Proxmox</a>(Version 2.1-1/fb0f63a)</li>
<li>Container OS: <a href="http://www.ubuntu.com/">Ubuntu Precise</a>(Version 12.04)</li>
</ul>


<p>Software(Installed in Container OS):</p>

<ul>
<li><a href="http://www.r-project.org/">R</a>(Version 2.14.1)

<ul>
<li><a href="http://www.stats.uwo.ca/faculty/yu/Rmpi/">Rmpi</a>(Version 0.5-9)</li>
<li><a href="http://cran.r-project.org/web/packages/snow/index.html">snow</a>(Version 0.3-10)</li>
</ul>
</li>
<li><a href="http://rstudio.org/">Rstudio</a>(Version 0.96.316)</li>
<li><a href="http://packages.ubuntu.com/precise/mpich2">MPICH2</a>(Version 1.4.1)</li>
</ul>


<h1>Set up Proxmox Cluster</h1>

<h2>Install Proxmox</h2>

<p>Please see <a href="http://pve.proxmox.com/wiki/Installation">Proxmox Installation</a></p>

<h2>Set up Proxmox Cluster</h2>

<p>Please see <a href="http://pve.proxmox.com/wiki/Proxmox_VE_Cluster#Create_a_Proxmox_VE_Cluster">Create a Proxmox VE Cluster</a></p>

<h2>Create a container</h2>

<p>An easy way is to create the container under the management console of Proxmox.</p>

<p>Please download the container template from [http://wiki.openvz.org/Download/template/precreated] and put it under <code>/var/lib/vz/template/cache/</code>.</p>

<p>Here, I write small shell script (modified from <a href="https://raw.github.com/drivard/openvz-create-container-script/master/createvz.sh">Here</a>)
to create the virtual container with 6 CPUs, 2G memory and 32G disk:</p>

<figure class='code'><figcaption><span>create_vz.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'><span class="nv">VZUID</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
</span><span class='line'><span class="nv">VZHOSTNAME</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>
</span><span class='line'><span class="nv">VZIP</span><span class="o">=</span><span class="s2">&quot;$3&quot;</span>
</span><span class='line'><span class="nv">VZTEMPLATE</span><span class="o">=</span><span class="s2">&quot;$4&quot;</span>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$1</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$2</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$3</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$4</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'>  /usr/bin/pvectl create <span class="nv">$VZUID</span> <span class="nv">$VZTEMPLATE</span> --cpus 6 --disk 32 --hostname <span class="nv">$VZHOSTNAME</span> --memory 2048 --swap 2048 --nameserver 8.8.8.8 --password initpasswd --pool Rslaves --netif <span class="nv">ifname</span><span class="o">=</span>eth0,mac<span class="o">=</span><span class="k">$(</span>./macgen.py<span class="k">)</span>,host_ifname<span class="o">=</span>veth103.0,host_mac<span class="o">=</span>&lt;host_mac&gt;,bridge<span class="o">=</span>vmbr0
</span><span class='line'>  /usr/bin/pvectl <span class="nb">set</span> <span class="nv">$VZUID</span> --ip_address <span class="nv">$VZIP</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;./create_vz.sh &lt;UID&gt; &lt;HOSTNAME&gt; &lt;IP&gt; &lt;TEMPLATE&gt;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /usr/bin/pvectl list
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that the initial root password is <em>initpasswd</em> and the user need to fill <host_mac> according to the mac address of the host.(run <code>ifconfig</code> in host machine or check the setting of the container created in management console).</p>

<p>The mac address is initialized according to the following python scripts:</p>

<figure class='code'><figcaption><span>macgen.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="c">#! /usr/bin/python</span>
</span><span class='line'><span class="c"># Filename: macgen.py</span>
</span><span class='line'><span class="c"># Usage: It&#39;s intended to generate MAC addresses for virtualized</span>
</span><span class='line'><span class="c">#        systems that created by Xen, OpenVZ, Vserver etc.</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'>
</span><span class='line'><span class="c"># The first line is defined for specified vendor</span>
</span><span class='line'><span class="n">mac</span> <span class="o">=</span> <span class="p">[</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
</span><span class='line'><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">),</span>
</span><span class='line'><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">),</span>
</span><span class='line'><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%02x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="n">mac</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>After creating <em>create_vz.sh</em> and <em>macgen.py</em> and put them into the same directory,
run the shell command <code>./create_vz.sh 200 Rmaster 192.168.0.100 /var/lib/vz/template/cache/ubuntu-12.04-x86_64.tar.gz</code></p>

<pre><code>Creating container private area (/var/lib/vz/template/cache/ubuntu-12.04-x86_64.tar.gz)
Performing postcreate actions
CT configuration saved to /etc/pve/openvz/200.conf
Container private area was created
CT configuration saved to /etc/pve/openvz/200.conf
</code></pre>

<h1>Set up the prototype of container</h1>

<p>I will set up everything in one container and copy it to other machines in Proxmox Cluster.</p>

<p>Note that the following commands are executed in the container under root privilege.</p>

<h2>Initialize</h2>

<p>Login the virtual machine via ssh(<code>ssh root@192.168.0.100</code>) with the initial root password.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>locale-gen --lang en_US en_US.UTF-8
</span><span class='line'>apt-get update
</span><span class='line'>apt-get upgrade -y
</span><span class='line'>apt-get install build-essential -y
</span></code></pre></td></tr></table></div></figure>


<h2>Install R</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>apt-get install r-base -y
</span></code></pre></td></tr></table></div></figure>


<h2>Set <em>/etc/hosts</em></h2>

<p>Here I&#8217;ll set up a clusters with 3 machines:</p>

<figure class='code'><figcaption><span>/etc/hosts</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>192.168.0.100 Rmaster
</span><span class='line'>192.168.0.101 Rslave1
</span><span class='line'>192.168.0.102 Rslave2
</span></code></pre></td></tr></table></div></figure>


<h2>Set SSH</h2>

<p>Enable ssh public key authentication.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>adduser ruser
</span><span class='line'>su ruser
</span><span class='line'>ssh-keygen -t dsa -N &quot;&quot; -f ~/.ssh/id_rsa
</span><span class='line'>cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys
</span><span class='line'>exit
</span></code></pre></td></tr></table></div></figure>


<p>Test</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>sudo -u ruser ssh ruser@localhost
</span></code></pre></td></tr></table></div></figure>


<p>We should directly login without prompt of password.</p>

<h2>Install MPICH2</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>apt-get install mpich2 -y
</span></code></pre></td></tr></table></div></figure>


<p>Check Install Result</p>

<p>Run <code>mpich2version</code></p>

<pre><code>MPICH2 Version:         1.4.1
MPICH2 Release date:    Wed Aug 24 14:40:04 CDT 2011
MPICH2 Device:          ch3:nemesis
MPICH2 configure:       --build=x86_64-linux-gnu --prefix=/usr --includedir=${prefix}/include --mandir=${prefix}/share/man --infodir=${prefix}/share/info --sysconfdir=/etc --localstatedir=/var --libexecdir=${prefix}/lib/mpich2 --srcdir=. --disable-maintainer-mode --disable-dependency-tracking --disable-silent-rules --enable-shared --prefix=/usr --enable-fc --disable-rpath --sysconfdir=/etc/mpich2 --includedir=/usr/include/mpich2 --docdir=/usr/share/doc/mpich2 --with-hwloc-prefix=system --enable-checkpointing --with-hydra-ckpointlib=blcr
MPICH2 CC:      gcc  -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Wformat-security -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Wformat-security -Werror=format-security -Wall  -O2
MPICH2 CXX:     c++  -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Wformat-security -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Wformat-security -Werror=format-security -Wall -O2
MPICH2 F77:     gfortran  -g -O2 -O2
MPICH2 FC:      gfortran   -O2
</code></pre>

<h2>Install Rmpi with MPICH2</h2>

<p>Comment out origin setting of <code>CC</code> and <code>SHLIB_LD</code>.
Add:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>#CC = ...
</span><span class='line'>CC = mpicc
</span><span class='line'>...
</span><span class='line'>#SHLIB_LD = ...
</span><span class='line'>SHLIB_LD=mpicc
</span></code></pre></td></tr></table></div></figure>


<p>Open <em>R</em> console and execute following commands to install <em>Rmpi</em> with <em>MPICH2</em>:</p>

<figure class='code'><figcaption><span>install Rmpi</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>install.packages<span class="p">(</span><span class="s">&#39;Rmpi&#39;</span><span class="p">,</span>configure.args<span class="o">=</span><span class="s">&quot;--with-Rmpi-type=MPICH2 --with-Rmpi-include=/usr/lib/mpich2/include --with-Rmpi-libpath=/usr/lib/mpich2/lib/ --with-mpi=/usr/include/mpich2/&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Recover <em>/etc/R/Makeconf</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>CC = ...
</span><span class='line'>#CC = mpicc
</span><span class='line'>...
</span><span class='line'>SHLIB_LD = ...
</span><span class='line'>#SHLIB_LD=mpicc
</span></code></pre></td></tr></table></div></figure>


<p>Modify <em>/usr/local/lib/R/site-library/Rmpi/Rslaves.sh</em> line 17:</p>

<figure class='code'><figcaption><span>/usr/local/lib/R/site-library/Rmpi/Rslaves.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>...
</span><span class='line'>        $R_HOME/bin/R --no-init-file --slave --no-save &lt; $1 &gt; /tmp/$hn.$2.$$.log 2&gt;&amp;1
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Note that without modification of <em>/usr/local/lib/R/site-library/Rmpi/Rslaves.sh</em> will produce <em>Permission denied</em> during <code>mpi.spawn.Rslaves</code>.</p>

<h2>Install snow</h2>

<p>Install <em>snow</em></p>

<figure class='code'><figcaption><span>insatll snow</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>install.packages<span class="p">(</span><span class="s">&quot;snow&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Spread Prototype</h1>

<p>In this section, the commands are executed in host OS (Proxmox) if there is no further explanation.</p>

<h2>Shutdown the prototype of container</h2>

<p>Before deploying the prototype of container to other machines, I suggest
to shutdown the prototype.</p>

<figure class='code'><figcaption><span>Under container</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>init 0
</span></code></pre></td></tr></table></div></figure>


<h2>Backup the Snapshot of the container</h2>

<p>run <code>vzdump -dumpdir . 200</code></p>

<figure class='code'><figcaption><span>Under container</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>INFO: starting new backup job: vzdump 200 --dumpdir .
</span><span class='line'>INFO: Starting Backup of VM 200 <span class="o">(</span>openvz<span class="o">)</span>
</span><span class='line'>INFO: CTID 200 exist unmounted down
</span><span class='line'>INFO: <span class="nv">status</span> <span class="o">=</span> stopped
</span><span class='line'>INFO: backup mode: stop
</span><span class='line'>INFO: ionice priority: 7
</span><span class='line'>INFO: creating archive <span class="s1">&#39;./vzdump-openvz-200-2012_08_16-13_53_23.tar&#39;</span>
</span><span class='line'>INFO: Total bytes written: 960901120 <span class="o">(</span>917MiB, 716MiB/s<span class="o">)</span>
</span><span class='line'>INFO: archive file size: 916MB
</span><span class='line'>INFO: delete old backup <span class="s1">&#39;./vzdump-openvz-200-2012_08_16-13_33_40.tar&#39;</span>
</span><span class='line'>INFO: Finished Backup of VM 200 <span class="o">(</span>00:00:02<span class="o">)</span>
</span><span class='line'>INFO: Backup job finished successfully
</span></code></pre></td></tr></table></div></figure>


<p>The Proxmox will dump the environment of the prototype container to one file whose size is about 1G.
Note that <em>200</em> is the <em>uid</em> of the prototype.</p>

<h2>Copy the prototype</h2>

<p>I spread the prototype with the following shell scripts.</p>

<p>Please remember to modify the <host_mac> or other settings to fit your own environment.</p>

<figure class='code'><figcaption><span>spread_vz.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'><span class="nv">VZUID</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
</span><span class='line'><span class="nv">VZHOSTNAME</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>
</span><span class='line'><span class="nv">VZIP</span><span class="o">=</span><span class="s2">&quot;$3&quot;</span>
</span><span class='line'><span class="nv">VZDUMP</span><span class="o">=</span><span class="s2">&quot;$4&quot;</span>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$1</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$2</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$3</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$4</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span>vzrestore <span class="nv">$VZDUMP</span> <span class="nv">$VZUID</span>
</span><span class='line'>  pvectl <span class="nb">set</span> <span class="nv">$VZUID</span> --ip_address <span class="nv">$VZIP</span> --netif <span class="nv">ifname</span><span class="o">=</span>eth0,mac<span class="o">=</span><span class="k">$(</span>./macgen.py<span class="k">)</span>,host_ifname<span class="o">=</span>veth<span class="nv">$VZUID</span>.0,host_mac<span class="o">=</span>&lt;host_mac&gt;,bridge<span class="o">=</span>vmbr0 --hostname <span class="nv">$VZHOSTNAME</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;./spread_vz.sh &lt;UID&gt; &lt;HOSTNAME&gt; &lt;IP&gt; &lt;VZDUMP&gt;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /usr/bin/pvectl list
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>run <code>./spread_vz.sh 201 Rslave1 192.168.0.101 vzdump-openvz-200-2012_08_16-13_53_23.tar</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>extracting archive &#39;/root/dump/vzdump-openvz-200-2012_08_16-13_53_23.tar&#39;
</span><span class='line'>Total bytes read: 960901120 (917MiB, 470MiB/s)
</span><span class='line'>restore configuration to &#39;/etc/pve/nodes/&lt;cluster1&gt;/openvz/201.conf&#39;
</span><span class='line'>CT configuration saved to /etc/pve/openvz/201.conf
</span></code></pre></td></tr></table></div></figure>


<p>run <code>./spread_vz.sh 202 Rslave2 192.168.0.102 vzdump-openvz-200-2012_08_16-13_53_23.tar</code> for second slave.</p>

<h2>Deploy the slave</h2>

<p>Just open the management console of Proxmox to migrate these new containers to other machines in Proxmox Cluster.</p>

<h2>Validate Environment</h2>

<ul>
<li>Start all containers.</li>
<li>Login to Rmaster as ruser.</li>
<li>Try ssh to Rslave1 and Rslave2 as ruser. It should not require password.</li>
<li>Check the content of <em>/etc/hosts</em> on all machines.</li>
<li>Create Rmpi.conf as</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Rmaster
</span><span class='line'>Rslave1
</span><span class='line'>Rslave2
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Create Rmpi.test.R as</li>
</ul>


<figure class='code'><figcaption><span>Rmpi.test.R</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>library<span class="p">(</span>Rmpi<span class="p">)</span>
</span><span class='line'>cl <span class="o">&lt;-</span> mpi.spawn.Rslaves<span class="p">(</span>nslaves<span class="o">=</span><span class="m">6</span><span class="p">)</span>
</span><span class='line'>mpi.close.Rslaves<span class="p">()</span>
</span><span class='line'>mpi.quit<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>execute <code>mpiexec -np 1 -f Rmpi.conf R --vanilla &lt; Rmpi.test.R</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>R version 2.14.1 (2011-12-22)
</span><span class='line'>Copyright (C) 2011 The R Foundation for Statistical Computing
</span><span class='line'>ISBN 3-900051-07-0
</span><span class='line'>Platform: x86_64-pc-linux-gnu (64-bit)
</span><span class='line'>
</span><span class='line'>R is free software and comes with ABSOLUTELY NO WARRANTY.
</span><span class='line'>You are welcome to redistribute it under certain conditions.
</span><span class='line'>Type &#39;license()&#39; or &#39;licence()&#39; for distribution details.
</span><span class='line'>
</span><span class='line'>  Natural language support but running in an English locale
</span><span class='line'>
</span><span class='line'>R is a collaborative project with many contributors.
</span><span class='line'>Type &#39;contributors()&#39; for more information and
</span><span class='line'>&#39;citation()&#39; on how to cite R or R packages in publications.
</span><span class='line'>
</span><span class='line'>Type &#39;demo()&#39; for some demos, &#39;help()&#39; for on-line help, or
</span><span class='line'>&#39;help.start()&#39; for an HTML browser interface to help.
</span><span class='line'>Type &#39;q()&#39; to quit R.
</span><span class='line'>
</span><span class='line'>&gt; library(Rmpi)
</span><span class='line'>&gt; cl &lt;- mpi.spawn.Rslaves(nslaves=6)
</span><span class='line'>        6 slaves are spawned successfully. 0 failed.
</span><span class='line'>master (rank 0, comm 1) of size 7 is running on: Rmaster
</span><span class='line'>slave1 (rank 1, comm 1) of size 7 is running on: Rslave1
</span><span class='line'>slave2 (rank 2, comm 1) of size 7 is running on: Rslave2
</span><span class='line'>slave3 (rank 3, comm 1) of size 7 is running on: Rmaster
</span><span class='line'>slave4 (rank 4, comm 1) of size 7 is running on: Rslave1
</span><span class='line'>slave5 (rank 5, comm 1) of size 7 is running on: Rslave2
</span><span class='line'>slave6 (rank 6, comm 1) of size 7 is running on: Rmaster
</span><span class='line'>&gt; mpi.close.Rslaves()
</span><span class='line'>[1] 1
</span><span class='line'>&gt; mpi.quit()
</span></code></pre></td></tr></table></div></figure>


<h2>Install Rstudio Server</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>apt-get install libssl0.9.8 libapparmor1 apparmor-utils -y
</span><span class='line'>wget http://download2.rstudio.org/rstudio-server-0.96.330-amd64.deb
</span><span class='line'>dpkg -i rstudio-server-0.96.330-amd64.deb
</span></code></pre></td></tr></table></div></figure>


<p>See <a href="http://rstudio.org/download/server">Download RStudio Server</a> for details.</p>

<h2>Set Rmpi in Rstudio Server</h2>

<h3>Configuration</h3>

<p>Create <em>/etc/Rmpi.conf</em></p>

<figure class='code'><figcaption><span>/etc/Rmpi.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Rmaster
</span><span class='line'>Rslave1
</span><span class='line'>Rslave2
</span></code></pre></td></tr></table></div></figure>


<p>Create <em>/usr/lib/rstudio-server/bin/rsession-mpiexec.sh</em>:</p>

<figure class='code'><figcaption><span>/usr/lib/rstudio-server/bin/rsession-mpiexec.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'>
</span><span class='line'>mpiexec -np 1 -f /etc/Rmpi.conf -errfile-pattern /tmp/mpiexec.error.log /usr/lib/rstudio-server/bin/rsession <span class="s2">&quot;$@&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Modify the privilege:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>chmod u+x /usr/lib/rstudio-server/bin/rsession-mpiexec.sh
</span><span class='line'>chmod g+x /usr/lib/rstudio-server/bin/rsession-mpiexec.sh
</span><span class='line'>chmod o+x /usr/lib/rstudio-server/bin/rsession-mpiexec.sh
</span></code></pre></td></tr></table></div></figure>


<p>Create or modify <em>/etc/rstudio/rserver.conf</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>rsession-path=/usr/lib/rstudio-server/bin/rsession-mpiexec.sh
</span><span class='line'>#rsession-path=/usr/lib/rstudio-server/bin/rsession
</span></code></pre></td></tr></table></div></figure>


<p>Modify <em>/etc/apparmor.d/rstudio-server</em>:</p>

<figure class='code'><figcaption><span>rstudio-server</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>  #/usr/lib/rstudio-server/bin/rsession ux,
</span><span class='line'>  /usr/lib/rstudio-server/bin/rsession-mpiexec.sh ux,
</span></code></pre></td></tr></table></div></figure>


<p>Restart Rstudio Server or restart the Rmaster</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rstudio-server restart
</span></code></pre></td></tr></table></div></figure>


<h3>Testing with <em>Rmpi</em></h3>

<p>Login into web interface of Rstudio and execute</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>library<span class="p">(</span>Rmpi<span class="p">)</span>
</span><span class='line'>cl <span class="o">&lt;-</span> mpi.spawn.Rslaves<span class="p">(</span>nslaves<span class="o">=</span><span class="m">6</span><span class="p">)</span>
</span><span class='line'>mpi.close.Rslaves<span class="p">()</span>
</span><span class='line'>mpi.quit<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>You should see the slaves are spawned in different container/machines.</p>

<h3>Testing with <em>snow</em></h3>

<p>Login into web interface of Rstudio and execute</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>library<span class="p">(</span>snow<span class="p">)</span>
</span><span class='line'>cl <span class="o">&lt;-</span> makeMPIcluster<span class="p">(</span>count <span class="o">=</span> <span class="m">18</span><span class="p">)</span>
</span><span class='line'>unlist<span class="p">(</span>clusterEvalQ<span class="p">(</span>cl<span class="p">,</span> system<span class="p">(</span><span class="s">&#39;hostname&#39;</span><span class="p">,</span>intern<span class="o">=</span><span class="kc">TRUE</span><span class="p">)))</span>
</span><span class='line'>stopCluster<span class="p">(</span>cl<span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You should see the hostname of slaves.</p>

<h1>Trouble Shooting:</h1>

<ul>
<li>Check the network environment

<ul>
<li>Is the <em>/etc/hosts</em> correct?</li>
<li>Can <em>ruser</em> ssh to slaves and masters without password prompt?</li>
</ul>
</li>
<li>Check logs:

<ul>
<li>the system log (/var/log/syslog)</li>
<li>mpiexec error log (/tmp/mpiexec.error.log) which is set in <em>/usr/lib/rstudio-server/bin/rsession-mpiexec.sh</em></li>
</ul>
</li>
</ul>


<p>Good Luck!</p>

<h1>Reference</h1>

<ul>
<li><a href="http://sealmemory.blogspot.tw/2012/05/ubuntu-1204-openmpi-cluster.html">海豹雜記: 使用 Ubuntu Linux 12.04 與 OpenMPI 架設 Cluster</a></li>
<li><a href="http://webappl.blogspot.tw/2012/01/install-rmpi-with-mpich2-environment.html">Web Application: Install Rmpi with MPICH2 environment</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[R closure]]></title>
    <link href="http://wush978.github.com/blog/2012/08/14/r-closure/"/>
    <updated>2012-08-14T22:27:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/08/14/r-closure</id>
    <content type="html"><![CDATA[<p>R 中<em>function</em>也可以是一種物件型態，或稱做叫作<em>closure</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>typeof<span class="p">(</span>rnorm<span class="p">)</span>
</span><span class='line'><span class="go">[1] &quot;closure&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>要比較兩個function物件，則可透過<code>body</code>這個函數：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>body<span class="p">(</span>rnorm<span class="p">)</span> <span class="o">==</span> body<span class="p">(</span>rexp<span class="p">)</span>
</span><span class='line'><span class="go">[1] FALSE</span>
</span><span class='line'><span class="gp">&gt; </span>body<span class="p">(</span>rnorm<span class="p">)</span> <span class="o">==</span> body<span class="p">(</span>temp<span class="p">)</span>
</span><span class='line'><span class="go">[1] TRUE</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Latex in Octopress]]></title>
    <link href="http://wush978.github.com/blog/2012/06/20/latex-in-octopress/"/>
    <updated>2012-06-20T13:01:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/06/20/latex-in-octopress</id>
    <content type="html"><![CDATA[<p>大致上參考<a href="http://chen.yanping.me/cn/blog/2012/03/10/octopress-with-latex/">在Octopress中使用Latex</a>即可。</p>

<h1>安裝</h1>

<ol>
<li>安裝kramdown</li>
</ol>


<figure class='code'><figcaption><span>install-kramdown</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>gem install kramdown
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>修改<code>/source/_includes/custom/head.html</code></li>
</ol>


<figure class='code'><figcaption><span>head.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!-- mathjax config similar to math.stackexchange --&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">tex2jax</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">inlineMath</span><span class="o">:</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;$&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;\\(&quot;</span><span class="p">,</span><span class="s2">&quot;\\)&quot;</span><span class="p">]</span> <span class="p">],</span>
</span><span class='line'>      <span class="nx">processEscapes</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">tex2jax</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">skipTags</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;noscript&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;textarea&#39;</span><span class="p">,</span> <span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Queue</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">all</span> <span class="o">=</span> <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">getAllJax</span><span class="p">(),</span> <span class="nx">i</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">all</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">all</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">SourceElement</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s1">&#39; has-jax&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
</span><span class='line'>   <span class="na">src=</span><span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>使用注意事項</h1>

<ol>
<li>這個是我自己測出來的bug: <em>在latex中的符號 <code>^</code> 之後要接空格才能正常使用</em>。</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Cormen Chp6]]></title>
    <link href="http://wush978.github.com/blog/2012/06/18/cormen-chp6/"/>
    <updated>2012-06-18T22:53:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/06/18/cormen-chp6</id>
    <content type="html"><![CDATA[<h1>Heapsort</h1>

<h2>6.1 Heaps</h2>

<h3>Heap Introduction</h3>

<ul>
<li>sorts $n$ elements in $O(nlog(n))$</li>
<li>in place
  ps. <em>in place</em> : only used $O(1)$ additional memory to store data</li>
<li>heat property: $$\mbox{Parent[PARENT(i)] } \leq \mbox{ A[i]}$$</li>
</ul>


<h3>Exercise</h3>

<h4>6.1-1</h4>

<p>min: $2 ^ h$<br/>
max: $2 ^ h - 1$</p>

<h4>6.1-2</h4>

<p>Mathematical Induction</p>

<h4>6.1-3</h4>

<p>Trivial</p>

<h4>6.1-4</h4>

<p>Leaf</p>

<h4>6.1-5</h4>

<p>Yes, it is</p>

<h4>6.1-6</h4>

<p>No, $6 &lt; 7$</p>

<h4>6.1-7</h4>

<p>Proof:
$$
\begin{eqnarray}
&amp; &amp; k \mbox{-th element is a leaf iff } 2k > n \newline
&amp;\Rightarrow&amp; k \geq \lfloor n/2 \rfloor + 1
\end{eqnarray}
$$</p>

<h2>6.2 Maintaining the heap property</h2>

<p><code>MaxHeapify(A,i)</code> convert a heap that the subtree rooted at $2 i$ and
$2 i + 1$ are max-heaps, but $A[i]$ might be smaller than one of its
child, thus violating the max-heap property.</p>

<p>The idea is to float-down $A[i]$.</p>

<h3>Exercise</h3>

<h4>6.2-6</h4>

<p>Give a special case such as root 0 and node 1.</p>

<h2>6.3 Building a heap</h2>

<p>Do <code>MaxHeapify(A,i)</code> from the leaf to the root.</p>

<ul>
<li>Initial: leaf is a valid subtree with heap property</li>
<li>Maintain: for each step of heapify, heap property is maintained</li>
<li>Termination:</li>
</ul>


<h3>Exercise</h3>

<h4>6.3-2</h4>

<p>Because <code>MaxHeapify(A,i)</code> needs <code>left(i)</code> and <code>right(i)</code> are subtree
with heap property.</p>

<h2>6.4 The heapsort algorithm</h2>

<h1>My own implementation</h1>

<p>File /home/wush/git-project/octopress-blog/source/downloads/code/cormen/data_structure/Heap.hpp could not be found
File /home/wush/git-project/octopress-blog/source/downloads/code/cormen/sorting/HeapSort.hpp could not be found</p>

<h1>Reference</h1>

<p>See my github repository: <a href="https://github.com/wush978/cormen">cormen</a> for details of the code.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Profiling R code]]></title>
    <link href="http://wush978.github.com/blog/2012/06/14/profiling-r-code/"/>
    <updated>2012-06-14T23:29:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/06/14/profiling-r-code</id>
    <content type="html"><![CDATA[<h1>簡介</h1>

<p>Profiling的意思就是去測量程式中每個函數的執行時間。
根據經驗法則，通常有80%的執行時間耗費在20%的程式碼中！
所以若有提昇執行效能的需求，第一步就是找出跑得慢得程式碼(bottlenecks)，再針對慢得程式碼去做優化。</p>

<h1>介紹</h1>

<p>ps. 以下的程式碼取自<a href="http://www.math.ncu.edu.tw/~chenwc/R_note/reference/debug/Rdebug.pdf">Rdebug</a></p>

<p>考慮以下三個函數：</p>

<figure class='code'><figcaption><span>fun1.R</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>fun1 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  res <span class="o">&lt;-</span> <span class="kc">NULL</span>
</span><span class='line'>  n <span class="o">&lt;-</span> nrow<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>  <span class="kr">for</span><span class="p">(</span>i in <span class="m">1</span>:n<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kr">if</span> <span class="p">(</span>!any<span class="p">(</span>is.na<span class="p">(</span>x<span class="p">[</span>i<span class="p">,])))</span> <span class="p">{</span>
</span><span class='line'>          res <span class="o">&lt;-</span> rbind<span class="p">(</span>res<span class="p">,</span> x<span class="p">[</span>i<span class="p">,])</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  res
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>fun2.R</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>fun2 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  n <span class="o">&lt;-</span> nrow<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>  res <span class="o">&lt;-</span> matrix<span class="p">(</span><span class="m">0</span><span class="p">,</span> n<span class="p">,</span> ncol<span class="p">(</span>x<span class="p">))</span>
</span><span class='line'>  k <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  <span class="kr">for</span><span class="p">(</span>i in <span class="m">1</span>:n<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kr">if</span> <span class="p">(</span>!any<span class="p">(</span>is.na<span class="p">(</span>x<span class="p">[</span>i<span class="p">,])))</span> <span class="p">{</span>
</span><span class='line'>          res<span class="p">[</span>k<span class="p">,]</span> <span class="o">&lt;-</span> x<span class="p">[</span>i<span class="p">,]</span>
</span><span class='line'>          k <span class="o">&lt;-</span> k <span class="o">+</span> <span class="m">1</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  res<span class="p">[</span><span class="m">1</span>:<span class="p">(</span>k<span class="o">-</span><span class="m">1</span><span class="p">),]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>fun3.R</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>fun3 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  omit <span class="o">&lt;-</span> <span class="kc">FALSE</span>
</span><span class='line'>  n <span class="o">&lt;-</span> ncol<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>  <span class="kr">for</span><span class="p">(</span>i in <span class="m">1</span>:n<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      omit <span class="o">&lt;-</span> omit <span class="o">|</span> is.na<span class="p">(</span>x<span class="p">[,</span>i<span class="p">])</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  x<span class="p">[</span>!omit<span class="p">,]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>將上述三個function分別寫成script檔案後，執行：</p>

<figure class='code'><figcaption><span>Rprof-exp-1.R</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>source<span class="p">(</span><span class="s">&#39;fun1.R&#39;</span><span class="p">)</span>
</span><span class='line'>source<span class="p">(</span><span class="s">&#39;fun2.R&#39;</span><span class="p">)</span>
</span><span class='line'>source<span class="p">(</span><span class="s">&#39;fun3.R&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>size.row <span class="o">&lt;-</span> <span class="m">10</span>L<span class="o">^</span><span class="m">5</span>
</span><span class='line'>size.col <span class="o">&lt;-</span> <span class="m">20</span>L
</span><span class='line'>
</span><span class='line'>x <span class="o">=</span> matrix<span class="p">(</span>rnorm<span class="p">(</span>size.row <span class="o">*</span> size.col<span class="p">),</span>size.row<span class="p">,</span>size.col<span class="p">)</span>
</span><span class='line'>x<span class="p">[</span>x <span class="o">&gt;</span> <span class="m">1.5</span><span class="p">]</span> <span class="o">=</span> <span class="kc">NA</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="s">&quot;method1.out&quot;</span><span class="p">)</span>
</span><span class='line'>fun1<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="kc">NULL</span><span class="p">)</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="s">&quot;method2.out&quot;</span><span class="p">)</span>
</span><span class='line'>fun2<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="kc">NULL</span><span class="p">)</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="s">&quot;method3.out&quot;</span><span class="p">)</span>
</span><span class='line'>fun3<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="kc">NULL</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>此時根目錄會有<code>method1.out</code>, <code>method2.out</code>, <code>method3.out</code>等三個檔案。</p>

<p>打開命令列，執行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>R CMD Rprof method1.out
</span><span class='line'>R CMD Rprof method2.out
</span><span class='line'>R CMD Rprof method3.out
</span></code></pre></td></tr></table></div></figure>


<p>以<code>R CMD Rprof method1.out</code>的結果為例：</p>

<pre><code>Each sample represents 0.02 seconds.
Total run time: 168.98 seconds.

Total seconds: time spent in function and callees.
Self seconds: time spent in function alone.

   %       total       %        self
 total    seconds     self    seconds    name
 100.0    168.98       0.4      0.74     fun1
  99.4    167.98      99.4    167.98     rbind
   0.1      0.20       0.1      0.20     any
   0.0      0.04       0.0      0.04     is.na
   0.0      0.02       0.0      0.02     !


   %        self       %      total
  self    seconds    total   seconds    name
  99.4    167.98      99.4    167.98     rbind
   0.4      0.74     100.0    168.98     fun1
   0.1      0.20       0.1      0.20     any
   0.0      0.04       0.0      0.04     is.na
   0.0      0.02       0.0      0.02     !
</code></pre>

<p>這份報告共有兩個表格：</p>

<ul>
<li>表格一：

<ul>
<li><code>fun1</code>(進入到退出之間)總共花了168.98秒，佔總時間的100%，但是本身(扣除可以分割的部份)只花了0.74秒，佔0.4%</li>
<li><code>rbind</code>(進去到退出之間)花了167.98秒，佔總時間的99.4%，但是本身花了167.98秒，佔整體的99.4%</li>
</ul>
</li>
<li>表格二則和表格一類似，只是表格一是依照進入和退出間所佔的時間來排序，而表格二是依照本身的執行時間來排序。</li>
</ul>


<p>由此可知，我們只要能夠針對表格二的前面數列的函數進行優化，就可以大幅度改進程式效能。</p>

<p>接下來看<code>R CMD Rprof method2.out</code>的結果：</p>

<pre><code>Each sample represents 0.02 seconds.
Total run time: 0.58 seconds.

Total seconds: time spent in function and callees.
Self seconds: time spent in function alone.

   %       total       %        self
 total    seconds     self    seconds    name
 100.0      0.58      69.0      0.40     fun2
  13.8      0.08      13.8      0.08     any
  10.3      0.06      10.3      0.06     is.na
   3.4      0.02       3.4      0.02     !
   3.4      0.02       3.4      0.02     matrix


   %        self       %      total
  self    seconds    total   seconds    name
  69.0      0.40     100.0      0.58     fun2
  13.8      0.08      13.8      0.08     any
  10.3      0.06      10.3      0.06     is.na
   3.4      0.02       3.4      0.02     !
   3.4      0.02       3.4      0.02     matrix
</code></pre>

<p>這裡使用<code>matrix</code>來取代<code>rbind</code>之後，剩下效能的瓶頸就落在<code>any</code>上。
所以<code>fun3</code>更進一步的不使用<code>any</code>，得到：</p>

<pre><code>Each sample represents 0.02 seconds.
Total run time: 0.12 seconds.

Total seconds: time spent in function and callee
Self seconds: time spent in function alone.

   %       total       %        self
 total    seconds     self    seconds    name
 100.0      0.12      16.7      0.02     fun3
  66.7      0.08      66.7      0.08     |
  16.7      0.02      16.7      0.02     is.na


   %        self       %      total
  self    seconds    total   seconds    name
  66.7      0.08      66.7      0.08     |
  16.7      0.02     100.0      0.12     fun3
  16.7      0.02      16.7      0.02     is.na
</code></pre>

<p>可以看到效能又好了近5倍(0.12 : 0.58)！</p>

<h1>參考資料</h1>

<ul>
<li><a href="http://www.math.ncu.edu.tw/~chenwc/R_note/reference/debug/Rdebug.pdf">Rdebug</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[R debug]]></title>
    <link href="http://wush978.github.com/blog/2012/06/14/r-debug/"/>
    <updated>2012-06-14T01:11:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/06/14/r-debug</id>
    <content type="html"><![CDATA[<h1>簡介</h1>

<p>很少人能夠第一次寫程式就能寫對，就連最專業的程式設計師也會花大把大把的時間在除錯。
所以熟悉除錯的工具也是能夠顯著的提昇寫程式的效率。</p>

<p>其實作者我在寫這篇文章之前也完全沒用過除錯工具！想到又能提昇自己的coding效率又讓我熊熊的燃燒起來！！</p>

<h1>除錯函數</h1>

<p>R 提供了以下的除錯功能:</p>

<ul>
<li><code>traceback</code></li>
<li><code>browser</code></li>
<li><code>debug</code></li>
<li><code>trace</code></li>
</ul>


<p>就讓我來一個個探索吧！</p>

<h2>traceback</h2>

<p>所謂的traceback功能主要的目的，是找出錯誤發生時最後執行的函數：</p>

<figure class='code'><figcaption><span>traceback-example-1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>fail_func1 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>size<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  b <span class="o">&lt;-</span> <span class="m">5</span>
</span><span class='line'>  b <span class="o">&lt;-</span> b <span class="o">+</span> size
</span><span class='line'>  b <span class="o">&lt;-</span> b <span class="o">*</span> <span class="m">2</span>
</span><span class='line'>  b <span class="o">&lt;-</span> b<span class="o">^</span><span class="m">2</span>
</span><span class='line'>  b
</span><span class='line'><span class="p">}</span>
</span><span class='line'>fail_func2 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>size<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  b <span class="o">&lt;-</span> fail_func1<span class="p">(</span>size<span class="p">)</span>
</span><span class='line'>  a <span class="o">&lt;-</span> sample<span class="p">(</span><span class="m">0</span>:<span class="m">1</span><span class="p">,</span>size<span class="p">,</span><span class="kc">FALSE</span><span class="p">)</span>
</span><span class='line'>  a
</span><span class='line'><span class="p">}</span>
</span><span class='line'>fail_func2<span class="p">(</span><span class="m">12</span><span class="p">)</span>
</span><span class='line'>traceback<span class="p">()</span>
</span><span class='line'>fail_func2<span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">)</span>
</span><span class='line'>traceback<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>運行結果：</p>

<figure class='code'><figcaption><span>traceback-example-1-output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>fail_func2<span class="p">(</span><span class="m">12</span><span class="p">)</span>
</span><span class='line'><span class="go">Error in sample(0:1, size, FALSE) : </span>
</span><span class='line'><span class="go">  cannot take a sample larger than the population when &#39;replace = FALSE&#39;</span>
</span><span class='line'><span class="gp">&gt; </span>traceback<span class="p">()</span>
</span><span class='line'><span class="go">2: sample(0:1, size, FALSE) at #3</span>
</span><span class='line'><span class="go">1: fail_func2(12)</span>
</span><span class='line'><span class="gp">&gt; </span>fail_func2<span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">)</span>
</span><span class='line'><span class="go">Error in b + size : non-numeric argument to binary operator</span>
</span><span class='line'><span class="gp">&gt; </span>traceback<span class="p">()</span>
</span><span class='line'><span class="go">2: fail_func1(size) at #2</span>
</span><span class='line'><span class="go">1: fail_func2(&quot;test&quot;)</span>
</span><span class='line'><span class="gp">&gt; </span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看出traceback確實的找出最後一個丟出錯誤的函數。</p>

<h2>browser</h2>

<p>traceback只能指出錯誤的發生處，並不能幫助使用者找出程式的錯誤。
接下來的<code>browser</code>指令則提供互動式的除錯功能：</p>

<ul>
<li>暫停程式碼的執行</li>
<li>讓使用者能察看某個時間點的變數狀態，甚至是修改變數狀態。此時以下的指令變成有特殊意義：

<ul>
<li><code>c</code> 讓程式繼續進行</li>
<li><code>n</code> 執行下一行</li>
<li><code>Q</code> 中斷</li>
</ul>
</li>
<li>繼續執行</li>
</ul>


<p>ps. 如果在中斷期間要查詢名稱為<code>c</code>、<code>n</code>、<code>Q</code>的變數內容，請用<code>print</code>指令。
但是我個人是認為不應該把變數取這類名稱！！</p>

<p>如果運行以下的指令：</p>

<figure class='code'><figcaption><span>browser-example-1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>global_env <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>fail_func1 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>size<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  fail_func1_env <span class="o">&lt;-</span> <span class="m">5</span>
</span><span class='line'>  browser<span class="p">()</span>
</span><span class='line'>  fail_func1_env <span class="o">&lt;-</span> <span class="m">6</span>
</span><span class='line'>  fail_func1_env <span class="o">&lt;-</span> <span class="m">7</span>
</span><span class='line'>  fail_func1_env
</span><span class='line'><span class="p">}</span>
</span><span class='line'>fail_func2 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>size<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  fail_func2_env <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  b <span class="o">&lt;-</span> fail_func1<span class="p">(</span>size<span class="p">)</span>
</span><span class='line'>  a <span class="o">&lt;-</span> sample<span class="p">(</span><span class="m">0</span>:<span class="m">1</span><span class="p">,</span>size<span class="p">,</span><span class="kc">FALSE</span><span class="p">)</span>
</span><span class='line'>  a
</span><span class='line'><span class="p">}</span>
</span><span class='line'>fail_func2<span class="p">(</span><span class="m">12</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>應該會看到類似以下的結果：</p>

<figure class='code'><figcaption><span>browser-example-1-output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>fail_func2<span class="p">(</span><span class="m">12</span><span class="p">)</span>
</span><span class='line'><span class="go">Called from: fail_func1(size)</span>
</span><span class='line'><span class="go">Browse[1]&gt; global_env</span>
</span><span class='line'><span class="go">[1] 1</span>
</span><span class='line'><span class="go">Browse[1]&gt; fail_func1_env</span>
</span><span class='line'><span class="go">[1] 5</span>
</span><span class='line'><span class="go">Browse[1]&gt; fail_func2_env</span>
</span><span class='line'><span class="go">Error: object &#39;fail_func2_env&#39; not found</span>
</span><span class='line'><span class="go">Browse[1]&gt; size</span>
</span><span class='line'><span class="go">[1] 12</span>
</span><span class='line'><span class="go">Browse[1]&gt; n</span>
</span><span class='line'><span class="go">debug at #4: fail_func1_env &lt;- 6</span>
</span><span class='line'><span class="go">Browse[2]&gt; fail_func1_env</span>
</span><span class='line'><span class="go">[1] 5</span>
</span><span class='line'><span class="go">Browse[2]&gt; n</span>
</span><span class='line'><span class="go">debug at #5: fail_func1_env &lt;- 7</span>
</span><span class='line'><span class="go">Browse[2]&gt; fail_func1_env</span>
</span><span class='line'><span class="go">[1] 6</span>
</span><span class='line'><span class="go">Browse[2]&gt; n</span>
</span><span class='line'><span class="go">debug at #6: fail_func1_env</span>
</span><span class='line'><span class="go">Browse[2]&gt; fail_func1_env</span>
</span><span class='line'><span class="go">[1] 7 </span>
</span></code></pre></td></tr></table></div></figure>


<p>在程式跑到<code>browser</code>時就暫停了。
因為<code>browser</code>是插入在<code>fail_func1</code>的第二行，所以變數應該和該時間點相同，
值得注意的是此時也只能存取該function environment內的變數</p>

<h2>debug</h2>

<p>我們可以把上一節的<code>browser</code>視為一種<em>中斷點</em>，
而<code>debug</code>函數則可以幫一個函數的每一行加入中斷點。
在對內建函數除錯的時候非常有用：</p>

<figure class='code'><figcaption><span>debug-example-1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>debug<span class="p">(</span>lm<span class="p">)</span>
</span><span class='line'>lm<span class="p">(</span>Sepal.Length~Species<span class="p">,</span>iris<span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>debug-example-1-output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>lm<span class="p">(</span>Sepal.Length~Species<span class="p">,</span>iris<span class="p">)</span>
</span><span class='line'><span class="go">debugging in: lm(Sepal.Length ~ Species, iris)</span>
</span><span class='line'><span class="go">debug: {</span>
</span><span class='line'><span class="go">    ret.x &lt;- x</span>
</span><span class='line'><span class="go">    ret.y &lt;- y</span>
</span><span class='line'><span class="go">... 略 ...</span>
</span><span class='line'><span class="go">    z</span>
</span><span class='line'><span class="go">}</span>
</span><span class='line'><span class="go">Browse[2]&gt; n</span>
</span><span class='line'><span class="go">debug: ret.x &lt;- x</span>
</span><span class='line'><span class="go">Browse[2]&gt; n</span>
</span><span class='line'><span class="go">debug: ret.y &lt;- y</span>
</span><span class='line'><span class="go">Browse[2]&gt; n</span>
</span><span class='line'><span class="go">debug: cl &lt;- match.call()</span>
</span></code></pre></td></tr></table></div></figure>


<p>除錯完畢後可用<code>undebug</code>來將中斷點移除。</p>

<h2>trace</h2>

<p>有時候只是檢視或修改變數並不夠。
<code>trace</code>函數能在除錯時插入程式碼到某個函數，
並在<code>untrace</code>後還原該函數。</p>

<figure class='code'><figcaption><span>str(trace)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>str<span class="p">(</span>trace<span class="p">)</span>
</span><span class='line'><span class="go">function (what, tracer, exit, at, print, signature, where = topenv(parent.frame()), </span>
</span><span class='line'><span class="go">    edit = FALSE)  </span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>what</code>: 要修改的函數名稱</li>
<li><code>tracer</code>: 要插入的函數或expression。<code>trace</code>會在<code>at</code>給的行數之前執行，或是<code>what</code>開始之前執行。</li>
<li><code>exit</code>: 當<code>what</code>結束之後執行的函數或expression</li>
<li><code>at</code>: <code>trace</code>執行的行數。</li>
</ul>


<p>其他的參數請參閱trace的說明。</p>

<p>測試一下：</p>

<figure class='code'><figcaption><span>trace-example-1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>test_func <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">2</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">3</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>trace<span class="p">(</span>test_func<span class="p">,</span> browser<span class="p">,</span> browser<span class="p">)</span>
</span><span class='line'>test_func<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>trace-example-1-output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>test_func<span class="p">()</span>
</span><span class='line'><span class="go">Tracing test_func() on entry </span>
</span><span class='line'><span class="go">Called from: eval(expr, envir, enclos)</span>
</span><span class='line'><span class="go">Browse[1]&gt; a</span>
</span><span class='line'><span class="go">Error: object &#39;a&#39; not found</span>
</span><span class='line'><span class="go">Browse[1]&gt; c</span>
</span><span class='line'><span class="go">Tracing test_func() on exit </span>
</span><span class='line'><span class="go">Called from: eval(expr, envir, enclos)</span>
</span><span class='line'><span class="go">Browse[1]&gt; a</span>
</span><span class='line'><span class="go">[1] 3</span>
</span><span class='line'><span class="go">Browse[1]&gt; c</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到第一次browser是在執行test_func之前，所以<code>a</code>不存在。
第二次則是離開的時候，所以<code>a</code>為<code>3</code>。</p>

<figure class='code'><figcaption><span>trace-example-2</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>test_func <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">2</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">3</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>trace<span class="p">(</span>test_func<span class="p">,</span> quote<span class="p">(</span>print<span class="p">(</span>a<span class="p">)),</span> at<span class="o">=</span><span class="m">3</span>:<span class="m">4</span><span class="p">)</span> <span class="c1">#利用quote直接插入print(a)到程式中</span>
</span><span class='line'>body<span class="p">(</span>test_func<span class="p">)</span>
</span><span class='line'>test_func<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>trace-example-2-output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>body<span class="p">(</span>test_func<span class="p">)</span>
</span><span class='line'><span class="go">{</span>
</span><span class='line'><span class="go">    a &lt;- 1</span>
</span><span class='line'><span class="go">    {</span>
</span><span class='line'><span class="go">        .doTrace(print(a), &quot;step 3&quot;)</span>
</span><span class='line'><span class="go">        a &lt;- 2</span>
</span><span class='line'><span class="go">    }</span>
</span><span class='line'><span class="go">    {</span>
</span><span class='line'><span class="go">        .doTrace(print(a), &quot;step 4&quot;)</span>
</span><span class='line'><span class="go">        a &lt;- 3</span>
</span><span class='line'><span class="go">    }</span>
</span><span class='line'><span class="go">}</span>
</span><span class='line'><span class="gp">&gt; </span>test_func<span class="p">()</span>
</span><span class='line'><span class="go">Tracing test_func() step 3 </span>
</span><span class='line'><span class="go">[1] 1</span>
</span><span class='line'><span class="go">Tracing test_func() step 4 </span>
</span><span class='line'><span class="go">[1] 2</span>
</span><span class='line'><span class="gp">&gt; </span>
</span></code></pre></td></tr></table></div></figure>


<p>搭配quote使用可以直接更改function的程式碼，好用好用！
注意at參數所代表的位置！！(讓我滿意外的)</p>

<h1>Reference</h1>

<p><a href="http://www.math.ncu.edu.tw/~chenwc/R_note/reference/debug/Rdebug.pdf">Rdebug</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rcpp-2]]></title>
    <link href="http://wush978.github.com/blog/2012/06/04/rcpp-2/"/>
    <updated>2012-06-04T13:56:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/06/04/rcpp-2</id>
    <content type="html"><![CDATA[<p>本文延續<a href="http://wush978.github.com/blog/2012/02/28/rcpp/">Rcpp-1</a>。</p>

<h1>從R傳遞資料到C++</h1>

<h2>傳遞到對應的物件</h2>

<h3>Vector</h3>

<p>在R的底層之中，最基礎的資料型態就是某六種型態的vector(詳情請見下表)。
傳遞這六種資料型態的vector到C++並不難，只要宣告對應的Rcpp class以及把透過<code>.Call</code>傳遞進來的SEXP丟到Rcpp class的constructor內就好了。</p>

<p>表一：</p>

<table>
<thead>
<tr>
<th>atomic type</th>
<th>Rcpp Class</th>
</tr>
</thead>
<tbody>
<tr>
<td>logical</td>
<td>LogicalVector</td>
</tr>
<tr>
<td>integer</td>
<td>IntegerVector</td>
</tr>
<tr>
<td>double</td>
<td>NumericVector</td>
</tr>
<tr>
<td>complex</td>
<td>ComplexVector</td>
</tr>
<tr>
<td>character</td>
<td>CharacterVector</td>
</tr>
<tr>
<td>raw</td>
<td>RawVector</td>
</tr>
</tbody>
</table>


<p>ps. 在R中，幾乎所有物件都是vector</p>

<p>以<code>integer</code>為例子:</p>

<figure class='code'><figcaption><span>test-rcpp.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &lt;Rcpp.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">Rcpp</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">RcppExport</span> <span class="n">SEXP</span> <span class="n">R2CppInteger</span><span class="p">(</span><span class="n">SEXP</span> <span class="n">RIntegerVec</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">SEXP</span> <span class="n">R2CppInteger</span><span class="p">(</span><span class="n">SEXP</span> <span class="n">r_int_vec</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">IntegerVector</span> <span class="n">int_vec</span><span class="p">(</span><span class="n">r_int_vec</span><span class="p">);</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">R_len_t</span> <span class="n">i</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">int_vec</span><span class="p">.</span><span class="n">length</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">Rprintf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">int_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">Rprintf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> length: %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">int_vec</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">R_NilValue</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>編譯後，在R底下執行</p>

<figure class='code'><figcaption><span>test.R</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>dyn.load<span class="p">(</span><span class="s">&quot;test-rcpp.so&quot;</span><span class="p">)</span>
</span><span class='line'>a <span class="o">&lt;-</span> <span class="m">1</span>L:<span class="m">10</span>L
</span><span class='line'><span class="m">.</span>Call<span class="p">(</span><span class="s">&quot;R2CppInteger&quot;</span><span class="p">,</span> a<span class="p">)</span>
</span><span class='line'>dyn.unload<span class="p">(</span><span class="s">&quot;test-rcpp.so&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>就會看到輸出</p>

<pre><code>1 2 3 4 5 6 7 8 9 10 
 length: 10 
NULL
</code></pre>

<p>如果需要使用上的細節，只需要查閱<a href="http://dirk.eddelbuettel.com/code/rcpp/html/classVector.html">Rcpp Reference中關於Vector</a>的部分。</p>

<p>而Rcpp還有許多可以直接傳遞其他進階的R物件的C++物件。</p>

<h3>Matrix</h3>

<p>因為R中的matrix 或 array 物件其實就是加上dimension的vector，所以可以直接用xxxVector物件在C++內處理。
Rcpp中另外還有更類似R的matrix的xxxMatrix物件。
只是要注意，在C++裡面取出來的row或column在C++裡的型態會是<code>Rcpp::xxxMatrix::Row</code>或<code>Rcpp::xxxMatrix::Column</code>。請見以下範例：</p>

<figure class='code'><figcaption><span>test-rcpp.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &lt;Rcpp.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">Rcpp</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">RcppExport</span> <span class="n">SEXP</span> <span class="n">R2CppInteger</span><span class="p">(</span><span class="n">SEXP</span> <span class="n">RIntegerVec</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">SEXP</span> <span class="n">R2CppInteger</span><span class="p">(</span><span class="n">SEXP</span> <span class="n">r_int_mat</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">IntegerMatrix</span> <span class="n">int_mat</span><span class="p">(</span><span class="n">r_int_mat</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Rprintf</span><span class="p">(</span><span class="s">&quot;print the matrix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">int_mat</span><span class="p">.</span><span class="n">nrow</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">int_mat</span><span class="p">.</span><span class="n">ncol</span><span class="p">();</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">Rprintf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">int_mat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">Rprintf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">Rprintf</span><span class="p">(</span><span class="s">&quot;print the first column: &quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">IntegerMatrix</span><span class="o">::</span><span class="n">Column</span> <span class="n">int_mat_col</span><span class="p">(</span> <span class="n">int_mat</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">NamedPlaceHolder</span><span class="p">(),</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">int_mat</span><span class="p">.</span><span class="n">nrow</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">Rprintf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">int_mat_col</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">Rprintf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">R_NilValue</span><span class="p">;</span> 
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>編譯之後在R底下執行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>dyn.load<span class="p">(</span><span class="s">&quot;test-rcpp.so&quot;</span><span class="p">)</span>
</span><span class='line'>a <span class="o">&lt;-</span> matrix<span class="p">(</span><span class="m">1</span>L:<span class="m">10</span>L<span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>
</span><span class='line'><span class="m">.</span>Call<span class="p">(</span><span class="s">&quot;R2CppInteger&quot;</span><span class="p">,</span> a<span class="p">)</span>
</span><span class='line'>dyn.unload<span class="p">(</span><span class="s">&quot;test-rcpp.so&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>就可以看到輸出</p>

<pre><code>print the matrix
1 3 5 7 9 
2 4 6 8 10 
print the first column: 1 2 
NULL
</code></pre>

<h3>List</h3>

<p>list物件在R也是非常的重要，而且和上述的vector型態已經不一樣了。
在R中，一個vector內的資料一定只能是相同的atomic type，但是在list中就可以放不同的atomic type。
說穿了，List物件也只是R物件的vector，這從Rcpp中List的定義：<code>typedef Vector&lt;VECSXP&gt; List</code>可窺見一二。</p>

<figure class='code'><figcaption><span>test-rcpp.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &lt;Rcpp.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">Rcpp</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">RcppExport</span> <span class="n">SEXP</span> <span class="n">R2CppList</span><span class="p">(</span><span class="n">SEXP</span> <span class="n">RList</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">Function</span> <span class="n">show</span><span class="p">(</span><span class="s">&quot;show&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">SEXP</span> <span class="n">R2CppList</span><span class="p">(</span><span class="n">SEXP</span> <span class="n">RList</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">List</span> <span class="n">list</span><span class="p">(</span><span class="n">RList</span><span class="p">);</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">R_len_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">show</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">R_NilValue</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ps. 這裡的Function是Rcpp中呼叫R function的方式，之後會再介紹。這裡的用途只是把傳入的東西以R中的<code>show</code>函數顯示到console上。</p>

<p>編譯之後在R底下執行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>dyn.load<span class="p">(</span><span class="s">&quot;test-rcpp.so&quot;</span><span class="p">)</span>
</span><span class='line'>a <span class="o">&lt;-</span> list<span class="p">()</span>
</span><span class='line'>a<span class="p">[[</span><span class="m">1</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="m">1</span>L:<span class="m">10</span>L
</span><span class='line'>a<span class="p">[[</span><span class="s">&#39;a&#39;</span><span class="p">]]</span> <span class="o">&lt;-</span> paste<span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="m">1</span>:<span class="m">10</span><span class="p">)</span>
</span><span class='line'>a<span class="p">[[</span><span class="m">2</span><span class="p">]]</span> <span class="o">&lt;-</span> factor<span class="p">(</span>sample<span class="p">(</span><span class="m">1</span>:<span class="m">2</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">))</span>
</span><span class='line'><span class="m">.</span>Call<span class="p">(</span><span class="s">&quot;R2CppList&quot;</span><span class="p">,</span> a<span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>就可以看到：</p>

<pre><code> [1]  1  2  3  4  5  6  7  8  9 10
 [1] 2 2 1 2 2 1 2 1 1 2
Levels: 1 2
NULL
</code></pre>

<h3>data.frame</h3>

<p>data.frame 其實就只是滿足某些條件的List物件，所以是可以用List物件來做處理的。
除此之外Rcpp也提供C++物件：DataFrame給使用者。
但是目前除了提供方便的建立DataFrame物件之外，只有類似List的操作方法。在此就不提供範例了。</p>

<h2>傳遞到STL物件</h2>

<p>Rcpp可以利用<code>as&lt;&gt;</code>函數將R物件轉換成對應的STL物件
。</p>

<h1>參考資料</h1>

<ul>
<li><a href="http://cran.r-project.org/doc/manuals/R-lang.html#Vector-objects">R Language Definition</a></li>
<li><a href="http://cran.r-project.org/web/packages/Rcpp/vignettes/Rcpp-quickref.pdf">Rcpp Quick Reference Guide</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[試用Interactive charts and slides with R]]></title>
    <link href="http://wush978.github.com/blog/2012/06/04/shi-yong-interactive-charts-and-slides-with-r/"/>
    <updated>2012-06-04T10:18:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/06/04/shi-yong-interactive-charts-and-slides-with-r</id>
    <content type="html"><![CDATA[<h1>簡介</h1>

<p>新版的RStudio(0.98.228) 推出了<a href="http://www.rstudio.org/docs/authoring/using_markdown">Using Markdown with RStudio</a>，這對於我這個markdown愛好者來說可是大利多呀!!</p>

<p>簡單來說，就是透過以下的流程產生文件:</p>

<p>Rmd &#8211;> Markdown &#8211;> HTML</p>

<p>這裡的Markdown同時還支援:</p>

<ul>
<li><a href="https://github.github.com/github-flavored-markdown">Github的擴充</a>，更方便的插入code block</li>
<li><a href="https://github.com/tanoku/sundown">Sundown</a>，支援表格等其他功能</li>
<li><a href="http://www.mathjax.org/">MathJax</a>，支援數學方程式</li>
</ul>


<p>想了就覺得非常方便!</p>

<h1>使用</h1>

<ol>
<li>安裝R package <a href="http://yihui.name/knitr/">knitr</a>。我在2.13版本之前的R是無法安裝的，所以想試用的朋友記得把R的版本更新。</li>
<li>打開Rstudio ，File &#8211;> New &#8211;> R Markdown</li>
<li>編輯markdown檔案，儲存為<code>xxx.Rmd</code>或<code>xxx.md</code>。注意: 副檔名若為<code>md</code>，就無法使用嵌入R圖片的功能。</li>
<li>點選編輯器上的<code>Knit HTML</code>就可以預覽產生的HTML格式。目前我個人在這部分遇到困難: 我沒有辦法把R畫出來的圖嵌入產生的HTML內。</li>
</ol>


<h1>語法範例</h1>

<p>這裡是我試過的範例。有興趣的大大可以到<a href="https://github.com/yihui/knitr/tree/master/inst/examples">knitr-example</a> 看看更多的範例。</p>

<ul>
<li>嵌入R語法:

<pre><code>  ``` {r}
  cat("hello world")
  ```
</code></pre></li>
<li>嵌入R圖面

<pre><code>  ``` {r 圖片標題, message=FALSE, fig.width=7, fig.height=5}
  plot(cars)
  ```
</code></pre></li>
<li>行內嵌入方程式

<pre><code>  $latex X_t = \mu_t + \varepsilon_t$
</code></pre></li>
<li>方程式區塊

<pre><code>  $$latex
      \begin{aligned}
      X_t = \mu_t + \varepsilon_t \\
      \varepsilon_t ~ Normal(0,1)
      \end{aligned}
  $$
</code></pre></li>
<li>跳脫字元

<ul>
<li>要跳脫<code>$latex</code>，使用HTML的語法: <code>&amp;#36;latex</code></li>
</ul>
</li>
</ul>


<h1>全命令列環境</h1>

<p>根據stackoverflow裏的某位大大提示，其實knitr套件提供了直接在R中轉換.Rmd至.md的語法：</p>

<figure class='code'><figcaption><span>rmd2md</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>require<span class="p">(</span>knitr<span class="p">)</span> <span class="c1"># required for knitting from rmd to md</span>
</span><span class='line'>require<span class="p">(</span>markdown<span class="p">)</span> <span class="c1"># required for md to html </span>
</span><span class='line'>knit<span class="p">(</span><span class="s">&#39;test.rmd&#39;</span><span class="p">,</span> <span class="s">&#39;test.md&#39;</span><span class="p">)</span> <span class="c1"># creates md file</span>
</span><span class='line'>markdownToHTML<span class="p">(</span><span class="s">&#39;test.md&#39;</span><span class="p">,</span> <span class="s">&#39;test.html&#39;</span><span class="p">)</span> <span class="c1"># creates html file</span>
</span><span class='line'>browseURL<span class="p">(</span>paste<span class="p">(</span><span class="s">&#39;file://&#39;</span><span class="p">,</span> file.path<span class="p">(</span>getwd<span class="p">(),</span><span class="s">&#39;test.html&#39;</span><span class="p">),</span> sep<span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">))</span> <span class="c1"># open file in browser</span>
</span></code></pre></td></tr></table></div></figure>


<p>理解了這件事情後，就可以寫出Makefile來在命令列編譯。</p>

<h1>我自己的擴充</h1>

<p>我都是透過php + R 來拼湊出下面這耶東西，環境都是Ubuntu</p>

<ul>
<li><a href="https://github.com/wush978/knitr2octopress">knitr2octopress</a> : 將Rmd轉換出來的.md檔案內的圖片連結，轉換為使用<a href="http://en.wikipedia.org/wiki/Data_URI_scheme">Data URI scheme</a>的格式。</li>
<li><a href="https://github.com/wush978/yml2rmd">yml2rmd</a> : 利用yml格式來產生大量圖表的.Rmd檔案，這個文件我還沒空寫, 以後慢慢補&#8230;</li>
</ul>


<h1>參考資料</h1>

<ul>
<li><a href="https://gist.github.com/2816027">Interactive charts and slides with R, googleVis and knitr</a></li>
<li><a href="http://www.r-bloggers.com/interactive-html-presentation-with-r-googlevis-knitr-pandoc-and-slidy/">R-blogger: Interactive HTML presentation with R, googleVis, knitr, pandoc and slidy</a></li>
<li><a href="http://stackoverflow.com/questions/10646665/how-to-convert-r-markdown-to-html-i-e-what-does-knit-html-do-in-rstudio-0-9">How to convert R Markdown to HTML? I.e., What does “Knit HTML” do in Rstudio 0.96?</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[eclipse-plugin]]></title>
    <link href="http://wush978.github.com/blog/2012/03/12/eclipse-plugin/"/>
    <updated>2012-03-12T18:16:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/03/12/eclipse-plugin</id>
    <content type="html"><![CDATA[<h1>相關的Eclipse Plugin</h1>


<ul>
<li><a href="http://subclipse.tigris.org/">Subclipse</a>

<ul>
<li>http://subclipse.tigris.org/update_1.8.x</li>
</ul>
</li>
<li><a href="https://github.com/pulse00/Symfony-2-Eclipse-Plugin/blob/master/README.md">Symfony Eclipse Plugin</a>

<ul>
<li>http://pulse00.github.com/p2/</li>
</ul>
</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[eclipse-svn-symfony]]></title>
    <link href="http://wush978.github.com/blog/2012/03/09/eclipse-svn-symfony/"/>
    <updated>2012-03-09T18:36:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/03/09/eclipse-svn-symfony</id>
    <content type="html"><![CDATA[<h1>Subclipse功能簡介</h1>




<h2>建立本機端的repository</h2>


<ul>
<li>於eclipse內打開SVN Repository的perspective</li>
<li>於SVN Repositories視窗內右邊的倒三角形 -> New repository&#8230;</li>
<li>選擇要建立repository的位置 -> OK</li>
</ul>


<h2>建立資料夾</h2>


<ul>
<li>右鍵點選repository -> New -> New remote folder</li>
<li>輸入資料夾名稱</li>
</ul>


<h2>匯入資料</h2>


<ul>
<li>右鍵點選資料夾 -> Import&#8230;</li>
<li>於Import directory內選擇要被匯入的資料</li>
<li>於Comment:內輸入註解</li>
<li>OK</li>
</ul>


<h2>Checkout並建立專案</h2>


<ul>
<li>右鍵點選要被Checkout的資料夾 -> Checkout&#8230;</li>
<li>選擇Check out as a project configured using the New Project Wizard</li>
<li>選擇Check out HEAD revision</li>
<li>選擇Depth:為Fully recursive</li>
<li>選擇Allow unversioned obstructions</li>
<li>Finish</li>
<li>選擇專案的種類為PHP Project</li>
<li>剩下的步驟同Eclipse建立新專案的步驟</li>
</ul>


<h2 id="commit">送交至Repository(Commit)</h2>


<ul>
<li>右鍵點選已經被修改的檔案 -> Team -> Commit&#8230;</li>
<li>視窗上方輸入要commit的message</li>
<li>視窗下方確認要送交的檔案/目錄</li>
<li>OK</li>
<li>請不要在送交的message內使用中文</li>
</ul>


<h2>自專案中新增檔案/目錄</h2>


<ul>
<li>右鍵點選要新增至repository的檔案/目錄 -> Team -> Add to Version Control</li>
<li>如果要取消, 請在右鍵點選要取消的檔案/目錄 -> Team -> Revert&#8230;</li>
<li><a href="#commit">送交</a>要新增的檔案/目錄</li>
</ul>


<h2>更新Repository</h2>


<ul>
<li>右鍵點選要更新的檔案/目錄 -> Team -> Update to HEAD</li>
</ul>


<h2>刪除Repository內的檔案/目錄</h2>


<ul>
<li>刪除檔案/目錄</li>
<li>送交</li>
</ul>


<h2>移動Repository內的檔案/目錄</h2>


<ul>
<li>移動檔案/目錄</li>
<li>送交</li>
</ul>


<h2>解決衝突</h2>


<ul>
<li>送交時發生out of date錯誤</li>
<li>更新時發現File conflicts</li>
<li>Edit Conflict</li>
<li>Mark Resolved&#8230;</li>
<li>送交</li>
</ul>


<h2>清除暫存的登入帳號密碼</h2>


<ul>
<li>Windows -> Preference -> Team -> SVN 檢查Client Adapter</li>
<li>依照<a href="http://subclipse.tigris.org/wiki/PluginFAQ#head-d507c29676491f4419997a76735feb6ef0aa8cf8">Subclipse Wiki FAQ</a>的指示清除對應的資料夾</li>
</ul>


<h1>Symfony和svn</h1>


<ul>
<li>於Repository內建立三個資料夾:

<pre><code>myproject/
  branches/
  tags/
  trunk/
</code></pre></li>
<li>複製Symfony資料夾至myproject內</li>
<li>更改Symfony資料夾的名稱為專案名稱(以下仍繼續使用Symfony)</li>
<li>右鍵點選Symfony/src -> Team -> Add to Version Control</li>
<li>忽略下列檔案:

<pre><code>vendor
app/內的bootstrap*
app/config/內的 parameters.ini
app/cache/內的 *
app/logs/內的 *
web/內的 bundles
</code></pre></li>
</ul>


<h1>參考資料</h1>


<ul>
<li><a href="http://symfony.com/doc/current/cookbook/workflow/new_project_svn.html">How to Create and store a Symfony2 Project in Subversion</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[php開發建置]]></title>
    <link href="http://wush978.github.com/blog/2012/03/09/build-php-development-enviornment/"/>
    <updated>2012-03-09T11:23:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/03/09/build-php-development-enviornment</id>
    <content type="html"><![CDATA[<ul>
<li><a href="#env">環境</a></li>
<li><a href="#dev-tool">開發工具</a></li>
<li><a href="#build-env">建置步驟</a>

<ul>
<li><a href="#IIS-php-fastcgi">安裝IIS7 + php-fastcgi</a></li>
<li><a href="#eclipse-svn">安裝eclipse-PDT和svn</a></li>
<li><a href="#import-svn">匯入既有的SVN Repository</a></li>
<li><a href="#xdebug">安裝Xdebug</a></li>
<li><a href="#remote-debug">設定遠端除錯環境</a></li>
<li><a href="#database">設定php和MSSQL的連線</a></li>
</ul>
</li>
<li><a href="#reference">參考網頁</a></li>
</ul>


<h1 id="env">環境</h1>


<ul>
<li>server: windows 2008 R2</li>
<li>client: windows 7</li>
<li>database: MSSQL 2008 R2 Express</li>
</ul>


<h1 id="dev-tool">開發工具</h1>


<ul>
<li><a href="http://www.eclipse.org/projects/project.php?id=tools.pdt">eclipse-PDT</a></li>
<li>svn

<ul>
<li><a href="http://tortoisesvn.net/downloads.html">tortoise-svn</a></li>
<li><a href="http://subclipse.tigris.org/">subclipse</a></li>
</ul>
</li>
</ul>


<p>ps. 本文件僅測試於IIS7, php5.3.10, eclipse-PDT 3.0.2, subclipse 1.8.x, XDebug 2.1.3</p>

<h1 id="build-env">建置步驟</h1>




<h2 id="IIS-php-fastcgi">安裝IIS7 + php-fastcgi</h2>


<ol>
<li>安裝IIS7

<ul>
<li>需安裝cgi</li>
</ul>
</li>
<li>安裝<a href="http://windows.php.net/download/">php5.3</a>

<ul>
<li>下載VC9 x86 Non Thread Safe ZIP</li>
<li>解壓縮到<em>c:\php</em></li>
</ul>
</li>
<li>安裝<a href="http://www.microsoft.com/download/en/details.aspx?id=29">Microsoft Visual C++ 2008 Redistributable Package (x86)</a></li>
<li>測試以下的命令碼：

<pre><code>c:\php\php.exe -i
</code></pre>

<p>ps. 如出現<em>side-by-side effect</em>的錯誤訊息表示步驟3有問題</p></li>
<li>設定<em>php.ini</em>：

<ul>
<li>複製php.ini-development至php.ini</li>
<li>修改以下內容：
fastcgi.impersonate = 1
cgi.fix_pathinfo = 1
date.timezone = &#8220;Asia/Taipei&#8221;</li>
</ul>
</li>
<li>設定fast-cgi Mapping Handler</li>
<li>至<em>c:\inetpub\wwwroot</em>建立<em>phpinfo.php</em>並修改內容為:

<pre><code>&lt;?php phpinfo() ?&gt;
</code></pre></li>
<li>打開*http://&lt;server的ip>/phpinfo.php須出現phpinfo畫面

<ul>
<li>如出現500可能是步驟5的<em>date.timezone</em>未設定成功</li>
</ul>
</li>
</ol>


<h2 id="eclipse-svn">安裝eclipse-PDT和svn</h2>


<ol>
<li>安裝jre, 雖然我不喜歡Oracle, 但這只是為了方便&#8230; <a href="http://java.com/en/download/manual.jsp">Sun Java</a></li>
<li>下載eclipse-PDT並解壓縮至<em>c:\eclipse-php</em>
ps. jre和eclipse-PDT必須同時為x86或x64</li>
<li>執行<em>c:\eclipse-php\eclipse.exe</em></li>
<li>安裝subclipse

<ul>
<li>Help -> Install New Software</li>
<li>在Work with:欄位輸入<code>http://subclipse.tigris.org/update_1.8.x</code></li>
<li>勾選Subclipse, SVNKit; 不勾選Subclipse底下的Subclipse Integration for Mylyn 3.x (Optional)</li>
</ul>
</li>
</ol>


<h2 id="import-svn">匯入既有的SVN Repository</h2>


<ol>
<li>於eclipse內打開<code>SVN repository Exploring</code> Perspective</li>
<li>於SVN Repositories內點右鍵, 選New</li>
<li>輸入svn repository的URL</li>
</ol>


<h2 id="xdebug">安裝XDebug</h2>


<ol>
<li>下載Xdebug Windows Binary(VC9 32bit)</li>
<li>將下載的.dll複製至<em>c:\php\ext</em></li>
<li>修改php.ini，新增以下內容

<pre><code>[xdebug]
zend_extension=c:\php\ext\php_xdebug-2.1.3-5.3-vc9-nts.dll
</code></pre></li>
<li>於命令列輸入<code>c:\php\php.exe -m</code>檢查輸出內有無xdebug</li>
</ol>


<h2 id="remote-debug">設定遠端除錯環境</h2>


<ol>
<li>修改要進行除錯的eclipse設定如下:

<ul>
<li>開啟PHP專案</li>
<li>Windows -> Preferences -> PHP -> Debug
將PHP Debugger從Zend Debugger改成Xdebug後，點選右邊的Configure&#8230;</li>
<li>於Installed Debuggers內選Xdebug後點右邊的Configure</li>
<li>Accept remote seesion (JIT) 從 off 改成 any 後點OK</li>
<li>點Apply</li>
</ul>
</li>
<li>設定要開網頁的瀏覽器(僅以Firefox為例)

<ul>
<li>安裝<a href="https://addons.mozilla.org/en-US/firefox/addon/58688/">easy Xdebug for FireFox</a></li>
</ul>
</li>
<li>設定php.ini:

<pre><code>[xdebug]
zend_extension=c:\php\ext\php_xdebug-2.1.3-5.3-vc9-nts.dll
xdebug.remote_enable=On
xdebug.remote_handler="dbgp"
xdebug.remote_mode="req"
xdebug.remote_port=9000
xdebug.remote_host="YOUR.IP.GOES.HERE"
xdebug.remote_log=/path/to/xdebug_remote_log
</code></pre></li>
</ol>


<h2 id="database">設定php和MSSQL的連線</h2>


<ul>
<li>下載並安裝<a href="http://www.microsoft.com/download/en/details.aspx?id=29">VC++ 2008 Redistributable Package(x86)</a></li>
<li>下載<a href="http://www.microsoft.com/download/en/details.aspx?id=20098#system-requirements">MS Driver 3.0 for SQL Server for PHP</a></li>
<li>修改php.ini，新增:</li>
</ul>


<figure class='code'><figcaption><span>php.ini</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="c">;...</span>
</span><span class='line'><span class="na">extension</span><span class="o">=</span><span class="s">c:\php\ext\php_pdo_sqlsrv_53_nts_vc9.dll</span>
</span><span class='line'><span class="c">;...</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>檢查能否讀取</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>c:<span class="se">\p</span>hp<span class="se">\p</span>hp -m
</span></code></pre></td></tr></table></div></figure>


<p>看看有無<code>pdo_sqlsrv</code></p>

<ul>
<li>還要安裝其他相依套件，請參考<a href="http://go.microsoft.com/fwlink/?LinkId=163712"><code>http://go.microsoft.com/fwlink/?LinkId=163712</code></a>。</li>
</ul>


<p>ps. 由於我本來就已經有VC9版本的ODBC Client、pdo_sqlsrv VC9版本，所以我安裝這些版本沒問題，但是在安裝新下載的3.0版本卻問題一堆。等到之後我有和它奮鬥後再把心得Po上來吧。</p>

<h1 id="reference">參考網頁</h1>


<ul>
<li><a href="" title="http://technet.microsoft.com/zh-tw/library/dd239230(v=ws.10).aspx">設定FastCGI以裝載PHP應用程式(IIS7)</a></li>
<li><a href="http://www.eclipse.org/projects/project.php?id=tools.pdt">Eclipse PDT</a></li>
<li><a href="http://subclipse.tigris.org/">Subclipse</a></li>
<li><a href="http://xdebug.org/docs/install">Xdebug Installation</a></li>
<li><a href="http://xdebug.org/docs/remote">Xdebug Remote Debugging</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[R: DateTime格式的心得]]></title>
    <link href="http://wush978.github.com/blog/2012/02/29/rdatetime/"/>
    <updated>2012-02-29T21:53:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/02/29/rdatetime</id>
    <content type="html"><![CDATA[<ul>
<li><a href="#overview">概述</a></li>
<li><a href="#functions">函數心得</a>

<ul>
<li>取得當前的時間

<ul>
<li><a href="#Sys.time">Sys.time</a></li>
<li><a href="#Sys.Date">Sys.Date</a></li>
</ul>
</li>
<li>時間格式間的轉換

<ul>
<li><a href="#mktime">mktime</a></li>
<li><a href="#localtime">localtime</a></li>
<li><a href="#gmtime">gmtime</a></li>
</ul>
</li>
<li>時間和字串間的轉換

<ul>
<li><a href="#strftime">strftime</a></li>
<li><a href="#strptime">strptime</a></li>
</ul>
</li>
<li><a href="#trunc">trunc</a></li>
</ul>
</li>
<li><a href="#reference">參考資料</a></li>
</ul>


<hr />

<h2 id="overview"> 概述 </h2>


<p>R中主要的時間物件為<code>POSIXct</code>和<code>POSIXlt</code>。[Date-Time Classes]第8頁內提到設計者們在設計這類物件的考量：</p>

<ul>
<li>日期格式應該由[locale]參數來決定。</li>
<li>時間應該由電腦的Time zones來決定。</li>
<li>參考資料庫標準(SQL99 ISO)中使用的時間格式<code>timestamp with time zone</code></li>
<li>考量到跨平台，使用[POSIX]</li>
</ul>


<p>[POSIX]是以<a href="Coordinated%20Universal%20Time">UTC</a>為基準，以c語言的<code>double</code>型態來儲存的時間格式，
而<code>POSIXct</code>則是代表以這種絕對座標所表示的時間。<code>POSIXlt</code>則是另一種包含timezones的格式
(lt代表local time)。其中timezone是以屬性tzone來代表的。</p>

<p>以以下的程式碼為例：</p>

<figure class='code'><figcaption><span>example from [Date-Time Classes]</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rout'><span class='line'><span class="gp">&gt; </span>file.info<span class="p">(</span>dir<span class="p">())[,</span> <span class="s">&quot;mtime&quot;</span><span class="p">,</span> drop<span class="o">=</span><span class="kc">FALSE</span><span class="p">]</span>
</span><span class='line'><span class="go">data                  2012-02-29 21:18:11</span>
</span></code></pre></td></tr></table></div></figure>


<p>在預設下，是以ISO標準格式來表示日期時間。</p>

<figure class='code'><figcaption><span>example from [Date-Time Classes]</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'><span class="o">&gt;</span> file_time <span class="o">&lt;-</span> file.info<span class="p">(</span>dir<span class="p">())[,</span> <span class="s">&quot;mtime&quot;</span><span class="p">,</span> drop<span class="o">=</span><span class="kc">FALSE</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;</span> file_time
</span><span class='line'>data                  <span class="m">2012</span><span class="o">-</span><span class="m">02</span><span class="o">-</span><span class="m">29</span> <span class="m">21</span>:<span class="m">18</span>:<span class="m">11</span>
</span><span class='line'><span class="o">&gt;</span> format<span class="p">(</span>file_time<span class="p">,</span> format<span class="o">=</span><span class="s">&quot;%x %X&quot;</span><span class="p">)</span>
</span><span class='line'>data                  <span class="m">2012</span><span class="o">/</span><span class="m">2</span><span class="o">/</span><span class="m">29</span> 下午 <span class="m">09</span>:<span class="m">18</span>:<span class="m">11</span>
</span></code></pre></td></tr></table></div></figure>


<p>另外再列了幾個[Date-Time Classes]內的範例</p>

<h2 id="functions"> 函數心得 </h2>




<h3 id="Sys.time"> Sys.time </h3>




<figure class='code'><figcaption><span>Sys.time</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'><span class="kr">function</span> <span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>回傳<code>POSIXct</code>物件來表示現在的時間</p>

<h3 id="Sys.Date"> Sys.Date</h3>




<figure class='code'><figcaption><span>Sys.time</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'><span class="kr">function</span> <span class="p">()</span> <span class="p">{</span>as.Date<span class="p">(</span>as.POSIXlt<span class="p">(</span>Sys.time<span class="p">()))}</span>
</span></code></pre></td></tr></table></div></figure>


<p>回傳<code>Date</code>物件來表示現在的日期</p>

<h3 id="trunc"> trunc </h3>




<figure class='code'><figcaption><span>trunc.POSIXt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'><span class="kr">function</span> <span class="p">(</span>x<span class="p">,</span> units <span class="o">=</span> c<span class="p">(</span><span class="s">&quot;secs&quot;</span><span class="p">,</span> <span class="s">&quot;mins&quot;</span><span class="p">,</span> <span class="s">&quot;hours&quot;</span><span class="p">,</span> <span class="s">&quot;days&quot;</span><span class="p">),</span> <span class="m">...</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>將<code>x</code>的時間格式轉換為以<code>units</code>為單位</p>

<h2 id="reference"> 參考資料 </h3>

[Date-Time Classes]: http://www.r-project.org/doc/Rnews/Rnews_2001-2.pdf
[locale]: http://en.wikipedia.org/wiki/Locale
[UTC]: http://en.wikipedia.org/wiki/Coordinated_Universal_Time

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rcpp-1]]></title>
    <link href="http://wush978.github.com/blog/2012/02/28/rcpp/"/>
    <updated>2012-02-28T15:42:00+08:00</updated>
    <id>http://wush978.github.com/blog/2012/02/28/rcpp</id>
    <content type="html"><![CDATA[<h1>Rcpp 心得 &#8211; 簡介</h1>

<ul>
<li><a href="#overview">概述</a>

<ul>
<li><a href="#background">背景知識</a></li>
<li><a href="#introduction">介紹</a></li>
<li><a href="#install">安裝</a></li>
<li><a href="#compile">編譯</a></li>
<li><a href="#reference">參考資料</a></li>
</ul>
</li>
</ul>


<hr />

<h2 id="overview"> 概述 </h2>




<h3 id="background"> 背景知識 </h3>


<p>就我所知，要能理解Rcpp的語法，你必須先對C++這個我個人認為最難學的語言先學到某種程度才行。根據<a href="http://www.amazon.com/Effective-Specific-Improve-Programs-Designs/dp/0321334876">Effective C++</a>的作者Scott Meyers的看法，C++其實是下列四種程式語言的集合(難怪很難，一個打四個!!):</p>

<ul>
<li>C的特性 (指標、陣列等等)</li>
<li>物件導向</li>
<li>STL 標準函式庫</li>
<li>Template</li>
</ul>


<p>Rcpp中大量的使用了後面三種，所以如果看不習慣Rcpp的使用者，可能得先回頭把C++後面三種的語法複習一下了。</p>

<h3 id="introduction"> 介紹 </h3>


<p><a href="http://dirk.eddelbuettel.com/code/rcpp.html">Rcpp</a> 是一個整合R和C++的library。
使用過R中的<code>.Call</code>函數的人一定會對於處理R和C之間資料結構的轉換感到很煩人，而Rcpp給我的第一個印象就是他把這些重複性很高的轉換給包起來了!所以在使用Rcpp時使用者不需要再去撰寫諸如以下的程式碼:</p>

<figure class='code'><figcaption><span>return a R integer vector with R API</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;R.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;Rdefines.h&gt;</span>
</span><span class='line'><span class="n">SEXP</span> <span class="nf">foo</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">SEXP</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>  <span class="n">PROTECT</span><span class="p">(</span><span class="n">retval</span> <span class="o">=</span> <span class="n">NEW_INTEGER</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span><span class='line'>  <span class="n">INTEGER_POINTER</span><span class="p">(</span><span class="n">retval</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="n">INTEGER_POINTER</span><span class="p">(</span><span class="n">retval</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>  <span class="n">UNPROTECT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在Rcpp中, 透過C++的物件導向和template語法可以用下列的語法得到相同的效果：</p>

<figure class='code'><figcaption><span>return a R integer vector with Rcpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &lt;Rcpp.h&gt;</span>
</span><span class='line'><span class="n">RcppExport</span> <span class="n">SEXP</span> <span class="n">foo</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">retval</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>  <span class="n">retval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="n">retval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">Rcpp</span><span class="o">::</span><span class="n">wrap</span><span class="p">(</span> <span class="n">retval</span> <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>比較上面兩段語法後，我基於以下的理由比較喜歡Rcpp的語法:</p>

<ol>
<li><p>Rcpp的語法比較簡潔。尤其是在比較<code>INTEGER_POINTER(retval)[0]</code>和<code>retval[0]</code>，
這種在真正寫功能時最常用到的語法，我比較喜歡使用後者。雖然你也可以再宣告一個指標:<code>int* retval_ptr = INTEGER_POINTER(retval)</code>
來達到類似的效果，但是對我來說, 明明都是代表<code>retval</code>這個物件，卻需要宣告兩個變數就是彆扭。</p></li>
<li><p>Rcpp可以使用更精確的型態。我認為比起<code>SEXP</code>或<code>NEW_INTEGER</code>，
<code>IntegerVector</code>是更清楚的，而且也更簡潔。除了<code>IntegerVector</code>外，Rcpp之中也定義了許許多多的型態，
甚至連<code>Matrix</code>、<code>Robj</code>(S4 object)和<code>environment</code>都有呢!</p></li>
<li><p>在物件導向的語法中我就可以依循<b>RAII(<a href="http://en.wikipedia.org/wiki/Resource_Acquisition_Is_Initialization">Resource Acquisition Is Initialization</a>)</b>的原則來寫code，
降低了memory leak等資源洩漏的可能，也免除了使用<code>PROTECT</code>、<code>UNPROTECT</code>的困擾。</p></li>
</ol>


<p>除了語法上吸引我之外，Rcpp還可以還可以和inline套件結合，直接在R內進行即時編譯；還可以和另一個套件sugar一起使用，再增加程式的執行效能。</p>

<h3 id="install"> 安裝 </h3>


<p>Rcpp的安裝非常簡單，和一般的R套件相同。有興趣的使用者還可以額外安裝inline或sugar來玩。
Windows的使用者請額外安裝能編譯R的工具庫: <a href="http://cran.r-project.org/bin/windows/Rtools/">Rtools</a> ，並且記得到Rcpp的目錄中不要包含空白，否則用R CMD SHLIB編譯的時候會有錯誤。</p>

<h3 id="compile"> 編譯 </h3>


<ol>
<li>使用inline，這也是最簡單的方式。以下是一個取自<a href="http://dirk.eddelbuettel.com/code/rcpp/Rcpp-FAQ.pdf">Frequently Asked Questions about Rcpp</a>的範例:</li>
</ol>


<figure class='code'><figcaption><span>Compile with R package &#8220;inline&#8221;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>fx <span class="o">&lt;-</span> cxxfunction<span class="p">(</span>signature<span class="p">(</span> x <span class="o">=</span> <span class="s">&quot;numeric&quot;</span> <span class="p">),</span> <span class="s">&#39;</span>
</span><span class='line'><span class="s">  NumericVector xx(x);</span>
</span><span class='line'><span class="s">  return wrap( std::accumulate( xx.begin(), xx.end(), 0.0));&#39;</span><span class="p">,</span>
</span><span class='line'>  plugin <span class="o">=</span> <span class="s">&quot;Rcpp&quot;</span><span class="p">)</span>
</span><span class='line'>res <span class="o">&lt;-</span> fx<span class="p">(</span> seq<span class="p">(</span> <span class="m">1</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> by <span class="o">=</span> <span class="m">0.5</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>res
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>使用R CMD SHLIB的話則需要調整compiler的參數。以下的範例是在bash底下執行，是透過修改環境變數的方式。</li>
</ol>


<figure class='code'><figcaption><span>Compile with R CMD SHLIB </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">PKG_LIBS</span><span class="o">=</span><span class="k">$(</span>Rscript -e <span class="s2">&quot;Rcpp:::LdFlags()&quot;</span><span class="k">)</span>
</span><span class='line'><span class="nb">export </span><span class="nv">PKG_CXXFLAGS</span><span class="o">=</span><span class="k">$(</span>Rscript -e <span class="s2">&quot;Rcpp::CxxFlags()&quot;</span><span class="k">)</span>
</span><span class='line'>R CMD SHLIB myfile.cpp
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>在R內呼叫Rcpp的函數<code>Rcpp:::SHLIB</code>來編譯。</li>
</ol>


<figure class='code'><figcaption><span>Compile with Rcpp:::SHLIB</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>Rcpp<span class="p">:::</span>SHLIB<span class="p">(</span><span class="s">&quot;mysource.cpp&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>在windows底下，方法2.我花了很久才測出來(網路上找到資料是說只要Rcpp和他的父目錄名稱有空白就會出錯)!後來我大部分是用方法1和3了。</p>

<h3 id="reference"> 參考資料 </h3>


<ul>
<li><a href="http://dirk.eddelbuettel.com/papers/Rcpp-introduction.pdf">Rcpp: Seamless R and C++ Interface</a></li>
<li><a href="http://dirk.eddelbuettel.com/code/rcpp/Rcpp-FAQ.pdf">Frequently Asked Questions about Rcpp</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
