
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Wush筆記</title>
  <meta name="author" content="Wush978">

  
  <meta name="description" content="Install 1
sudo apt-get install postgresql Configure 1
2
sudo -u postgres createuser -D -P ruser
sudo -u postgres createdb -O ruser ruserdb Edit /etc/ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://wush978.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Wush筆記" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-29552301-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Wush筆記</a></h1>
  
    <h2>紀錄學習過程的點點滴滴</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:wush978.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/30/initialize-postgresql/">Initialize PostgreSQL in Ubuntu 12.04</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-30T13:41:00+08:00" pubdate data-updated="true">Aug 30<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/30/initialize-postgresql/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Install</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo apt-get install postgresql
</span></code></pre></td></tr></table></div></figure>


<h1>Configure</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo -u postgres createuser -D -P ruser
</span><span class='line'>sudo -u postgres createdb -O ruser ruserdb
</span></code></pre></td></tr></table></div></figure>


<p>Edit <code>/etc/postgresql/9.1/main/pg_hba.conf</code>.</p>

<p>Change this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">local   </span>all             all                                     peer
</span></code></pre></td></tr></table></div></figure>


<p>to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">local   </span>all             all                                     md5
</span></code></pre></td></tr></table></div></figure>


<p>Restart service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo service postgresql restart
</span></code></pre></td></tr></table></div></figure>


<h1>Reference</h1>

<ul>
<li><a href="http://blog.deliciousrobots.com/2011/12/13/get-postgres-working-on-ubuntu-or-linux-mint/">GET POSTGRES WORKING ON UBUNTU OR LINUX MINT</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/30/benchmark-of-saving-and-loading-r-objects/">Benchmark of Saving and Loading R Objects</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-30T12:48:00+08:00" pubdate data-updated="true">Aug 30<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/30/benchmark-of-saving-and-loading-r-objects/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Introduction</h1>

<p>To compare the speed of saving and loading R objects to and from MongoDB
with or without serialization.</p>

<h1>Environment</h1>

<ul>
<li>OpenVZ with Ubuntu 12.04, i7-2600 CPU @ 3.4GHz, 2 processors, 4G RAM</li>
<li>Local MongoDB</li>
<li>Local PostgreSQL</li>
<li>R 1.14.1</li>
<li>rmongodb 1.0.3</li>
<li>RPostgreSQL 0.3-2</li>
</ul>


<h1>Initialize</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo apt-get install mongodb
</span></code></pre></td></tr></table></div></figure>


<h2>R</h2>

<figure class='code'><figcaption><span>install libpq-dev</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo apt-get install libpq-dev
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>install R packages</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>install.packages<span class="p">(</span><span class="s">&quot;rmongodb&quot;</span><span class="p">)</span>
</span><span class='line'>install.packages<span class="p">(</span><span class="s">&quot;RPostgreSQL&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Benchmark</h1>

<figure class='code'><figcaption><span>Test saving object serialized or not</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'><span class="p">{</span> <span class="c1"># loading package</span>
</span><span class='line'>  library<span class="p">(</span>rmongodb<span class="p">)</span>
</span><span class='line'>  mongo <span class="o">&lt;-</span> mongo.create<span class="p">()</span>
</span><span class='line'>  <span class="kr">if</span> <span class="p">(</span>!mongo.is.connected<span class="p">(</span>mongo<span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    stop<span class="p">(</span><span class="s">&quot;disconnected&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>save1 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>a<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">for</span><span class="p">(</span>i in <span class="m">1</span>:repeat.time<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    b <span class="o">&lt;-</span> mongo.bson.from.list<span class="p">(</span>list<span class="p">(</span>Rdata <span class="o">=</span> a<span class="p">))</span>
</span><span class='line'>    mongo.insert<span class="p">(</span>mongo<span class="p">,</span> <span class="s">&quot;test.save1&quot;</span><span class="p">,</span> b<span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>load1 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  result <span class="o">&lt;-</span> list<span class="p">()</span>
</span><span class='line'>  length<span class="p">(</span>result<span class="p">)</span> <span class="o">&lt;-</span> repeat.time
</span><span class='line'>  cursor <span class="o">&lt;-</span> mongo.find<span class="p">(</span>mongo<span class="p">,</span> <span class="s">&quot;test.save1&quot;</span><span class="p">)</span>
</span><span class='line'>  index <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  <span class="kr">while</span><span class="p">(</span>mongo.cursor.next<span class="p">(</span>cursor<span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    result<span class="p">[[</span>index<span class="p">]]</span> <span class="o">&lt;-</span> mongo.bson.to.list<span class="p">(</span>mongo.cursor.value<span class="p">(</span>cursor<span class="p">))</span>
</span><span class='line'>    index <span class="o">&lt;-</span> index <span class="o">+</span> <span class="m">1</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  result
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>save2 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>a<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">for</span><span class="p">(</span>i in <span class="m">1</span>:repeat.time<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    buf <span class="o">&lt;-</span> mongo.bson.buffer.create<span class="p">()</span>
</span><span class='line'>    mongo.bson.buffer.append<span class="p">(</span>buf<span class="p">,</span> <span class="s">&quot;Rdata&quot;</span><span class="p">,</span> serialize<span class="p">(</span>a<span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">))</span>
</span><span class='line'>    mongo.insert<span class="p">(</span>mongo<span class="p">,</span> <span class="s">&quot;test.save2&quot;</span><span class="p">,</span> mongo.bson.from.buffer<span class="p">(</span>buf<span class="p">))</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>load2 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  result <span class="o">&lt;-</span> list<span class="p">()</span>
</span><span class='line'>  length<span class="p">(</span>result<span class="p">)</span> <span class="o">&lt;-</span> repeat.time
</span><span class='line'>  cursor <span class="o">&lt;-</span> mongo.find<span class="p">(</span>mongo<span class="p">,</span> <span class="s">&quot;test.save2&quot;</span><span class="p">)</span>
</span><span class='line'>  index <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  <span class="kr">while</span><span class="p">(</span>mongo.cursor.next<span class="p">(</span>cursor<span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    result<span class="p">[[</span>index<span class="p">]]</span> <span class="o">&lt;-</span> unserialize<span class="p">(</span>mongo.bson.value<span class="p">(</span>mongo.cursor.value<span class="p">(</span>cursor<span class="p">),</span> <span class="s">&quot;Rdata&quot;</span><span class="p">))</span>
</span><span class='line'>    index <span class="o">&lt;-</span> index <span class="o">+</span> <span class="m">1</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  result
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>repeat.time <span class="o">&lt;-</span> <span class="m">1000</span>
</span><span class='line'>mongo.drop.database<span class="p">(</span>mongo<span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">)</span>
</span><span class='line'>a <span class="o">&lt;-</span> matrix<span class="p">(</span>rnorm<span class="p">(</span><span class="m">100</span><span class="o">^</span><span class="m">2</span><span class="p">),</span> <span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
</span><span class='line'>system.time<span class="p">({</span> <span class="c1">#direct way</span>
</span><span class='line'>  print<span class="p">(</span><span class="s">&quot;directly save and load&quot;</span><span class="p">)</span>
</span><span class='line'>  save1<span class="p">(</span>a<span class="p">)</span>
</span><span class='line'>  a.result <span class="o">&lt;-</span> load1<span class="p">()</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>system.time<span class="p">({</span> <span class="c1">#serialized way</span>
</span><span class='line'>  print<span class="p">(</span><span class="s">&quot;serialized before save and load&quot;</span><span class="p">)</span>
</span><span class='line'>  save2<span class="p">(</span>a<span class="p">)</span>
</span><span class='line'>  a.result2 <span class="o">&lt;-</span> load2<span class="p">()</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>I tested many times and notice that the results are very unstable, and
I guess that the serialized way is faster a little bit.</p>

<p>I paste some results here:</p>

<figure class='code'><figcaption><span>Test saving object serialized or not</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.226</span>   <span class="m">0.083</span>   <span class="m">4.221</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.746</span>   <span class="m">0.095</span>   <span class="m">3.578</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.227</span>   <span class="m">0.090</span>   <span class="m">3.981</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.771</span>   <span class="m">0.106</span>   <span class="m">3.327</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.232</span>   <span class="m">0.104</span>   <span class="m">3.808</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.760</span>   <span class="m">0.110</span>   <span class="m">3.289</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.303</span>   <span class="m">0.078</span>   <span class="m">3.827</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.763</span>   <span class="m">0.109</span>   <span class="m">3.413</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.237</span>   <span class="m">0.089</span>   <span class="m">3.834</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.773</span>   <span class="m">0.091</span>   <span class="m">3.458</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.247</span>   <span class="m">0.114</span>   <span class="m">3.970</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.781</span>   <span class="m">0.110</span>   <span class="m">3.738</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.331</span>   <span class="m">0.142</span>   <span class="m">4.329</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.753</span>   <span class="m">0.098</span>   <span class="m">3.202</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.217</span>   <span class="m">0.090</span>   <span class="m">3.766</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.737</span>   <span class="m">0.097</span>   <span class="m">5.339</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.231</span>   <span class="m">0.103</span>   <span class="m">3.875</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.751</span>   <span class="m">0.105</span>   <span class="m">3.377</span>
</span><span class='line'>rmongodb package <span class="p">(</span>mongo<span class="o">-</span>r<span class="o">-</span>driver<span class="p">)</span> loaded
</span><span class='line'>Use <span class="s">&#39;help(&quot;mongo&quot;)&#39;</span> to get started.
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="kc">TRUE</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;directly save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">1.202</span>   <span class="m">0.085</span>   <span class="m">6.935</span>
</span><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;serialized before save and load&quot;</span>
</span><span class='line'>   user  system elapsed
</span><span class='line'>  <span class="m">0.752</span>   <span class="m">0.082</span>   <span class="m">3.996</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/24/pros-and-cons-of-virtualized-system/">我喜歡使用虛擬化系統</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-24T11:01:00+08:00" pubdate data-updated="true">Aug 24<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/24/pros-and-cons-of-virtualized-system/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>之前我因為工作的關係, 需要使用虛擬化系統來跑測試。</p>

<p>這陣子在架了Proxmox的Virtualization Cluster後覺得這種系統在跑科學模擬上真是太方便，理由如下：</p>

<ul>
<li>環境管理: 我可以對整台機器的環境進行備份、還原和複製。</li>
<li>穩定: 虛擬機器內再怎麼當機怎麼毀滅, 幾乎不會影響到整台機器。所以我不用跑到實驗室去重開，頂多進入Proxmox主控台去重開虛擬機器即可。</li>
</ul>


<p>而使用Proxmox的理由則是：</p>

<ul>
<li>Free</li>
<li>我熟悉ubuntu/debian system</li>
</ul>


<p>當然這樣做也是有一些缺點：</p>

<ul>
<li>學習曲線: 我發現在這種東西的學習上, 我似乎比一般人還敏感一點, 所以我可以接受比較陡峭的學習曲線。</li>
<li>效能: 這點我還沒有空去實際測試。但是虛擬機器正常來說效能是會比較慢的。以目前我的經驗是，使用OpenVZ的虛擬化技術上並沒有感受到特別的效能損失。</li>
</ul>


<p>有興趣或有類似需求或的朋友可以參考看看</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/21/rcpparmadillo/">RcppArmadillo</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-21T20:08:00+08:00" pubdate data-updated="true">Aug 21<span>st</span>, 2012</time>
        
         | <a href="/blog/2012/08/21/rcpparmadillo/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Inroduction</h1>

<p>Recently I am exploring the linear algebra features provided in <a href="http://arma.sourceforge.net/">Armadillo</a> through <a href="http://dirk.eddelbuettel.com/code/rcpp.armadillo.html">RcppArmadillo</a>.</p>

<p>Here is the note for myself.</p>

<p>Note these functions are only my understanding of these operators and methods. I didn&#8217;t check the source code of Armadillo and RcppArmadillo.</p>

<h1>Basic Elements and Methods</h1>

<figure class='code'><figcaption><span>mat</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">a</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span> <span class="c1">// Initialize a 5 x 5 matrix.</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// fill it with 0</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">n_rows</span><span class="p">;</span>    <span class="c1">//!&lt; number of rows in the matrix (read-only)</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">n_cols</span><span class="p">;</span>    <span class="c1">//!&lt; number of columns in the matrix (read-only)</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">n_elem</span><span class="p">;</span>    <span class="c1">//!&lt; number of elements in the matrix (read-only)</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">vec_state</span><span class="p">;</span> <span class="c1">//!&lt; 0: matrix layout; 1: column vector layout; 2: row vector layout</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">mem</span><span class="p">;</span>         <span class="c1">//!&lt; pointer to memory used by the matrix (memory is read-only)</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">min</span><span class="p">();</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">max</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Feature</h1>

<h2>Matrix Multiplication</h2>

<figure class='code'><figcaption><span>Matrix Multiplication</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="k">operator</span><span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">y</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Transpose</h2>

<figure class='code'><figcaption><span>Transpose</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">arma</span><span class="o">::</span><span class="n">trans</span><span class="p">(</span><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Methods of class arma::mat</span>
</span><span class='line'><span class="c1">// x.t() = arma::trans(x)</span>
</span><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">::</span><span class="n">t</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Inverse</h2>

<figure class='code'><figcaption><span>Inverse</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">arma</span><span class="o">::</span><span class="n">pinv</span><span class="p">(</span><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Sum of Square</h2>

<figure class='code'><figcaption><span>Sum of Square</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kr">inline</span> <span class="kt">double</span> <span class="n">sumOfSquare</span><span class="p">(</span><span class="n">arma</span><span class="o">::</span><span class="n">vec</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">inner_product</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">x</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">x</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Diagonal Vector</h2>

<figure class='code'><figcaption><span>Diagonal Vector</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">colvec</span> <span class="n">arma</span><span class="o">::</span><span class="n">diagvec</span><span class="p">(</span><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Linear Regression</h2>

<figure class='code'><figcaption><span>Linear Regression</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * @param X    the explanatory variables</span>
</span><span class='line'><span class="cm"> * @param y    the response variable</span>
</span><span class='line'><span class="cm"> * @return     the vector of regression coefficients</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">colvec</span> <span class="n">arma</span><span class="o">::</span><span class="n">solve</span><span class="p">(</span><span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">mat</span><span class="o">&amp;</span> <span class="n">X</span><span class="p">,</span> <span class="k">const</span> <span class="n">arma</span><span class="o">::</span><span class="n">vec</span><span class="o">&amp;</span> <span class="n">y</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Residuals</span>
</span><span class='line'><span class="n">arma</span><span class="o">::</span><span class="n">colvec</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">X</span> <span class="o">*</span> <span class="n">coef</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Residual Sum of Square</span>
</span><span class='line'><span class="kt">double</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">sumOfSquare</span><span class="p">(</span><span class="n">residuals</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Std of Coef.</span>
</span><span class='line'><span class="n">arma</span><span class="o">::</span><span class="n">colvec</span> <span class="n">sderr</span> <span class="o">=</span> <span class="n">arma</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2</span> <span class="o">*</span>
</span><span class='line'>  <span class="n">arma</span><span class="o">::</span><span class="n">diagvec</span><span class="p">(</span><span class="n">arma</span><span class="o">::</span><span class="n">pinv</span><span class="p">(</span><span class="n">arma</span><span class="o">::</span><span class="n">trans</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="n">X</span><span class="p">)));</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/16/proxmox-and-r-cluster/">Proxmox &amp; R Cluster</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-16T11:57:00+08:00" pubdate data-updated="true">Aug 16<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/16/proxmox-and-r-cluster/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here I&#8217;ll show how to set up my parallel computing environment of R.</p>

<h1>Introduction</h1>

<p>As far as I know, the virtualization for linux with <a href="http://wiki.openvz.org/Main_Page">OpenVZ</a> does not loss too many computation efficiency.
Moreover, it provides a simple way to <em>copy</em> whole computation environment from one machine to another.
The consistency of the environment reduces the difficulty of setting MPI between machines, so I decide
to build my R cluster under Proxmox, which is an easy to use open source virtualization platform.</p>

<h1>Environment</h1>

<p>OS:</p>

<ul>
<li>Host OS: <a href="http://www.proxmox.com/">Proxmox</a>(Version 2.1-1/fb0f63a)</li>
<li>Container OS: <a href="http://www.ubuntu.com/">Ubuntu Precise</a>(Version 12.04)</li>
</ul>


<p>Software(Installed in Container OS):</p>

<ul>
<li><a href="http://www.r-project.org/">R</a>(Version 2.14.1)

<ul>
<li><a href="http://www.stats.uwo.ca/faculty/yu/Rmpi/">Rmpi</a>(Version 0.5-9)</li>
<li><a href="http://cran.r-project.org/web/packages/snow/index.html">snow</a>(Version 0.3-10)</li>
</ul>
</li>
<li><a href="http://rstudio.org/">Rstudio</a>(Version 0.96.316)</li>
<li><a href="http://packages.ubuntu.com/precise/mpich2">MPICH2</a>(Version 1.4.1)</li>
</ul>


<h1>Set up Proxmox Cluster</h1>

<h2>Install Proxmox</h2>

<p>Please see <a href="http://pve.proxmox.com/wiki/Installation">Proxmox Installation</a></p>

<h2>Set up Proxmox Cluster</h2>

<p>Please see <a href="http://pve.proxmox.com/wiki/Proxmox_VE_Cluster#Create_a_Proxmox_VE_Cluster">Create a Proxmox VE Cluster</a></p>

<h2>Create a container</h2>

<p>An easy way is to create the container under the management console of Proxmox.</p>

<p>Please download the container template from [http://wiki.openvz.org/Download/template/precreated] and put it under <code>/var/lib/vz/template/cache/</code>.</p>

<p>Here, I write small shell script (modified from <a href="https://raw.github.com/drivard/openvz-create-container-script/master/createvz.sh">Here</a>)
to create the virtual container with 6 CPUs, 2G memory and 32G disk:</p>

<figure class='code'><figcaption><span>create_vz.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'><span class="nv">VZUID</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
</span><span class='line'><span class="nv">VZHOSTNAME</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>
</span><span class='line'><span class="nv">VZIP</span><span class="o">=</span><span class="s2">&quot;$3&quot;</span>
</span><span class='line'><span class="nv">VZTEMPLATE</span><span class="o">=</span><span class="s2">&quot;$4&quot;</span>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$1</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$2</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$3</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$4</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'>  /usr/bin/pvectl create <span class="nv">$VZUID</span> <span class="nv">$VZTEMPLATE</span> --cpus 6 --disk 32 --hostname <span class="nv">$VZHOSTNAME</span> --memory 2048 --swap 2048 --nameserver 8.8.8.8 --password initpasswd --pool Rslaves --netif <span class="nv">ifname</span><span class="o">=</span>eth0,mac<span class="o">=</span><span class="k">$(</span>./macgen.py<span class="k">)</span>,host_ifname<span class="o">=</span>veth103.0,host_mac<span class="o">=</span>&lt;host_mac&gt;,bridge<span class="o">=</span>vmbr0
</span><span class='line'>  /usr/bin/pvectl <span class="nb">set</span> <span class="nv">$VZUID</span> --ip_address <span class="nv">$VZIP</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;./create_vz.sh &lt;UID&gt; &lt;HOSTNAME&gt; &lt;IP&gt; &lt;TEMPLATE&gt;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /usr/bin/pvectl list
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that the initial root password is <em>initpasswd</em> and the user need to fill <host_mac> according to the mac address of the host.(run <code>ifconfig</code> in host machine or check the setting of the container created in management console).</p>

<p>The mac address is initialized according to the following python scripts:</p>

<figure class='code'><figcaption><span>macgen.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="c">#! /usr/bin/python</span>
</span><span class='line'><span class="c"># Filename: macgen.py</span>
</span><span class='line'><span class="c"># Usage: It&#39;s intended to generate MAC addresses for virtualized</span>
</span><span class='line'><span class="c">#        systems that created by Xen, OpenVZ, Vserver etc.</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'>
</span><span class='line'><span class="c"># The first line is defined for specified vendor</span>
</span><span class='line'><span class="n">mac</span> <span class="o">=</span> <span class="p">[</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
</span><span class='line'><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">),</span>
</span><span class='line'><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">),</span>
</span><span class='line'><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%02x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="n">mac</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>After creating <em>create_vz.sh</em> and <em>macgen.py</em> and put them into the same directory,
run the shell command <code>./create_vz.sh 200 Rmaster 192.168.0.100 /var/lib/vz/template/cache/ubuntu-12.04-x86_64.tar.gz</code></p>

<pre><code>Creating container private area (/var/lib/vz/template/cache/ubuntu-12.04-x86_64.tar.gz)
Performing postcreate actions
CT configuration saved to /etc/pve/openvz/200.conf
Container private area was created
CT configuration saved to /etc/pve/openvz/200.conf
</code></pre>

<h1>Set up the prototype of container</h1>

<p>I will set up everything in one container and copy it to other machines in Proxmox Cluster.</p>

<p>Note that the following commands are executed in the container under root privilege.</p>

<h2>Initialize</h2>

<p>Login the virtual machine via ssh(<code>ssh root@192.168.0.100</code>) with the initial root password.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>locale-gen --lang en_US en_US.UTF-8
</span><span class='line'>apt-get update
</span><span class='line'>apt-get upgrade -y
</span><span class='line'>apt-get install build-essential -y
</span></code></pre></td></tr></table></div></figure>


<h2>Install R</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>apt-get install r-base -y
</span></code></pre></td></tr></table></div></figure>


<h2>Set <em>/etc/hosts</em></h2>

<p>Here I&#8217;ll set up a clusters with 3 machines:</p>

<figure class='code'><figcaption><span>/etc/hosts</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>192.168.0.100 Rmaster
</span><span class='line'>192.168.0.101 Rslave1
</span><span class='line'>192.168.0.102 Rslave2
</span></code></pre></td></tr></table></div></figure>


<h2>Set SSH</h2>

<p>Enable ssh public key authentication.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>adduser ruser
</span><span class='line'>su ruser
</span><span class='line'>ssh-keygen -t dsa -N &quot;&quot; -f ~/.ssh/id_rsa
</span><span class='line'>cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys
</span><span class='line'>exit
</span></code></pre></td></tr></table></div></figure>


<p>Test</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>sudo -u ruser ssh ruser@localhost
</span></code></pre></td></tr></table></div></figure>


<p>We should directly login without prompt of password.</p>

<h2>Install MPICH2</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>apt-get install mpich2 -y
</span></code></pre></td></tr></table></div></figure>


<p>Check Install Result</p>

<p>Run <code>mpich2version</code></p>

<pre><code>MPICH2 Version:         1.4.1
MPICH2 Release date:    Wed Aug 24 14:40:04 CDT 2011
MPICH2 Device:          ch3:nemesis
MPICH2 configure:       --build=x86_64-linux-gnu --prefix=/usr --includedir=${prefix}/include --mandir=${prefix}/share/man --infodir=${prefix}/share/info --sysconfdir=/etc --localstatedir=/var --libexecdir=${prefix}/lib/mpich2 --srcdir=. --disable-maintainer-mode --disable-dependency-tracking --disable-silent-rules --enable-shared --prefix=/usr --enable-fc --disable-rpath --sysconfdir=/etc/mpich2 --includedir=/usr/include/mpich2 --docdir=/usr/share/doc/mpich2 --with-hwloc-prefix=system --enable-checkpointing --with-hydra-ckpointlib=blcr
MPICH2 CC:      gcc  -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Wformat-security -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Wformat-security -Werror=format-security -Wall  -O2
MPICH2 CXX:     c++  -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Wformat-security -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Wformat-security -Werror=format-security -Wall -O2
MPICH2 F77:     gfortran  -g -O2 -O2
MPICH2 FC:      gfortran   -O2
</code></pre>

<h2>Install Rmpi with MPICH2</h2>

<p>Comment out origin setting of <code>CC</code> and <code>SHLIB_LD</code>.
Add:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>#CC = ...
</span><span class='line'>CC = mpicc
</span><span class='line'>...
</span><span class='line'>#SHLIB_LD = ...
</span><span class='line'>SHLIB_LD=mpicc
</span></code></pre></td></tr></table></div></figure>


<p>Open <em>R</em> console and execute following commands to install <em>Rmpi</em> with <em>MPICH2</em>:</p>

<figure class='code'><figcaption><span>install Rmpi</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>install.packages<span class="p">(</span><span class="s">&#39;Rmpi&#39;</span><span class="p">,</span>configure.args<span class="o">=</span><span class="s">&quot;--with-Rmpi-type=MPICH2 --with-Rmpi-include=/usr/lib/mpich2/include --with-Rmpi-libpath=/usr/lib/mpich2/lib/ --with-mpi=/usr/include/mpich2/&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Recover <em>/etc/R/Makeconf</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>CC = ...
</span><span class='line'>#CC = mpicc
</span><span class='line'>...
</span><span class='line'>SHLIB_LD = ...
</span><span class='line'>#SHLIB_LD=mpicc
</span></code></pre></td></tr></table></div></figure>


<p>Modify <em>/usr/local/lib/R/site-library/Rmpi/Rslaves.sh</em> line 17:</p>

<figure class='code'><figcaption><span>/usr/local/lib/R/site-library/Rmpi/Rslaves.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>...
</span><span class='line'>        $R_HOME/bin/R --no-init-file --slave --no-save &lt; $1 &gt; /tmp/$hn.$2.$$.log 2&gt;&amp;1
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Note that without modification of <em>/usr/local/lib/R/site-library/Rmpi/Rslaves.sh</em> will produce <em>Permission denied</em> during <code>mpi.spawn.Rslaves</code>.</p>

<h2>Install snow</h2>

<p>Install <em>snow</em></p>

<figure class='code'><figcaption><span>insatll snow</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>install.packages<span class="p">(</span><span class="s">&quot;snow&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Spread Prototype</h1>

<p>In this section, the commands are executed in host OS (Proxmox) if there is no further explanation.</p>

<h2>Shutdown the prototype of container</h2>

<p>Before deploying the prototype of container to other machines, I suggest
to shutdown the prototype.</p>

<figure class='code'><figcaption><span>Under container</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>init 0
</span></code></pre></td></tr></table></div></figure>


<h2>Backup the Snapshot of the container</h2>

<p>run <code>vzdump -dumpdir . 200</code></p>

<figure class='code'><figcaption><span>Under container</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>INFO: starting new backup job: vzdump 200 --dumpdir .
</span><span class='line'>INFO: Starting Backup of VM 200 <span class="o">(</span>openvz<span class="o">)</span>
</span><span class='line'>INFO: CTID 200 exist unmounted down
</span><span class='line'>INFO: <span class="nv">status</span> <span class="o">=</span> stopped
</span><span class='line'>INFO: backup mode: stop
</span><span class='line'>INFO: ionice priority: 7
</span><span class='line'>INFO: creating archive <span class="s1">&#39;./vzdump-openvz-200-2012_08_16-13_53_23.tar&#39;</span>
</span><span class='line'>INFO: Total bytes written: 960901120 <span class="o">(</span>917MiB, 716MiB/s<span class="o">)</span>
</span><span class='line'>INFO: archive file size: 916MB
</span><span class='line'>INFO: delete old backup <span class="s1">&#39;./vzdump-openvz-200-2012_08_16-13_33_40.tar&#39;</span>
</span><span class='line'>INFO: Finished Backup of VM 200 <span class="o">(</span>00:00:02<span class="o">)</span>
</span><span class='line'>INFO: Backup job finished successfully
</span></code></pre></td></tr></table></div></figure>


<p>The Proxmox will dump the environment of the prototype container to one file whose size is about 1G.
Note that <em>200</em> is the <em>uid</em> of the prototype.</p>

<h2>Copy the prototype</h2>

<p>I spread the prototype with the following shell scripts.</p>

<p>Please remember to modify the <host_mac> or other settings to fit your own environment.</p>

<figure class='code'><figcaption><span>spread_vz.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'><span class="nv">VZUID</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
</span><span class='line'><span class="nv">VZHOSTNAME</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>
</span><span class='line'><span class="nv">VZIP</span><span class="o">=</span><span class="s2">&quot;$3&quot;</span>
</span><span class='line'><span class="nv">VZDUMP</span><span class="o">=</span><span class="s2">&quot;$4&quot;</span>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$1</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$2</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$3</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$4</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span>vzrestore <span class="nv">$VZDUMP</span> <span class="nv">$VZUID</span>
</span><span class='line'>  pvectl <span class="nb">set</span> <span class="nv">$VZUID</span> --ip_address <span class="nv">$VZIP</span> --netif <span class="nv">ifname</span><span class="o">=</span>eth0,mac<span class="o">=</span><span class="k">$(</span>./macgen.py<span class="k">)</span>,host_ifname<span class="o">=</span>veth<span class="nv">$VZUID</span>.0,host_mac<span class="o">=</span>&lt;host_mac&gt;,bridge<span class="o">=</span>vmbr0 --hostname <span class="nv">$VZHOSTNAME</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;./spread_vz.sh &lt;UID&gt; &lt;HOSTNAME&gt; &lt;IP&gt; &lt;VZDUMP&gt;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /bin/echo <span class="s2">&quot;&quot;</span>
</span><span class='line'>  /usr/bin/pvectl list
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>run <code>./spread_vz.sh 201 Rslave1 192.168.0.101 vzdump-openvz-200-2012_08_16-13_53_23.tar</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>extracting archive &#39;/root/dump/vzdump-openvz-200-2012_08_16-13_53_23.tar&#39;
</span><span class='line'>Total bytes read: 960901120 (917MiB, 470MiB/s)
</span><span class='line'>restore configuration to &#39;/etc/pve/nodes/&lt;cluster1&gt;/openvz/201.conf&#39;
</span><span class='line'>CT configuration saved to /etc/pve/openvz/201.conf
</span></code></pre></td></tr></table></div></figure>


<p>run <code>./spread_vz.sh 202 Rslave2 192.168.0.102 vzdump-openvz-200-2012_08_16-13_53_23.tar</code> for second slave.</p>

<h2>Deploy the slave</h2>

<p>Just open the management console of Proxmox to migrate these new containers to other machines in Proxmox Cluster.</p>

<h2>Validate Environment</h2>

<ul>
<li>Start all containers.</li>
<li>Login to Rmaster as ruser.</li>
<li>Try ssh to Rslave1 and Rslave2 as ruser. It should not require password.</li>
<li>Check the content of <em>/etc/hosts</em> on all machines.</li>
<li>Create Rmpi.conf as</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Rmaster
</span><span class='line'>Rslave1
</span><span class='line'>Rslave2
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Create Rmpi.test.R as</li>
</ul>


<figure class='code'><figcaption><span>Rmpi.test.R</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>library<span class="p">(</span>Rmpi<span class="p">)</span>
</span><span class='line'>cl <span class="o">&lt;-</span> mpi.spawn.Rslaves<span class="p">(</span>nslaves<span class="o">=</span><span class="m">6</span><span class="p">)</span>
</span><span class='line'>mpi.close.Rslaves<span class="p">()</span>
</span><span class='line'>mpi.quit<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>execute <code>mpiexec -np 1 -f Rmpi.conf R --vanilla &lt; Rmpi.test.R</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>R version 2.14.1 (2011-12-22)
</span><span class='line'>Copyright (C) 2011 The R Foundation for Statistical Computing
</span><span class='line'>ISBN 3-900051-07-0
</span><span class='line'>Platform: x86_64-pc-linux-gnu (64-bit)
</span><span class='line'>
</span><span class='line'>R is free software and comes with ABSOLUTELY NO WARRANTY.
</span><span class='line'>You are welcome to redistribute it under certain conditions.
</span><span class='line'>Type &#39;license()&#39; or &#39;licence()&#39; for distribution details.
</span><span class='line'>
</span><span class='line'>  Natural language support but running in an English locale
</span><span class='line'>
</span><span class='line'>R is a collaborative project with many contributors.
</span><span class='line'>Type &#39;contributors()&#39; for more information and
</span><span class='line'>&#39;citation()&#39; on how to cite R or R packages in publications.
</span><span class='line'>
</span><span class='line'>Type &#39;demo()&#39; for some demos, &#39;help()&#39; for on-line help, or
</span><span class='line'>&#39;help.start()&#39; for an HTML browser interface to help.
</span><span class='line'>Type &#39;q()&#39; to quit R.
</span><span class='line'>
</span><span class='line'>&gt; library(Rmpi)
</span><span class='line'>&gt; cl &lt;- mpi.spawn.Rslaves(nslaves=6)
</span><span class='line'>        6 slaves are spawned successfully. 0 failed.
</span><span class='line'>master (rank 0, comm 1) of size 7 is running on: Rmaster
</span><span class='line'>slave1 (rank 1, comm 1) of size 7 is running on: Rslave1
</span><span class='line'>slave2 (rank 2, comm 1) of size 7 is running on: Rslave2
</span><span class='line'>slave3 (rank 3, comm 1) of size 7 is running on: Rmaster
</span><span class='line'>slave4 (rank 4, comm 1) of size 7 is running on: Rslave1
</span><span class='line'>slave5 (rank 5, comm 1) of size 7 is running on: Rslave2
</span><span class='line'>slave6 (rank 6, comm 1) of size 7 is running on: Rmaster
</span><span class='line'>&gt; mpi.close.Rslaves()
</span><span class='line'>[1] 1
</span><span class='line'>&gt; mpi.quit()
</span></code></pre></td></tr></table></div></figure>


<h2>Install Rstudio Server</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>apt-get install libssl0.9.8 libapparmor1 apparmor-utils -y
</span><span class='line'>wget http://download2.rstudio.org/rstudio-server-0.96.330-amd64.deb
</span><span class='line'>dpkg -i rstudio-server-0.96.330-amd64.deb
</span></code></pre></td></tr></table></div></figure>


<p>See <a href="http://rstudio.org/download/server">Download RStudio Server</a> for details.</p>

<h2>Set Rmpi in Rstudio Server</h2>

<h3>Configuration</h3>

<p>Create <em>/etc/Rmpi.conf</em></p>

<figure class='code'><figcaption><span>/etc/Rmpi.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Rmaster
</span><span class='line'>Rslave1
</span><span class='line'>Rslave2
</span></code></pre></td></tr></table></div></figure>


<p>Create <em>/usr/lib/rstudio-server/bin/rsession-mpiexec.sh</em>:</p>

<figure class='code'><figcaption><span>/usr/lib/rstudio-server/bin/rsession-mpiexec.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'>
</span><span class='line'>mpiexec -np 1 -f /etc/Rmpi.conf -errfile-pattern /tmp/mpiexec.error.log /usr/lib/rstudio-server/bin/rsession <span class="s2">&quot;$@&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Modify the privilege:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>chmod u+x /usr/lib/rstudio-server/bin/rsession-mpiexec.sh
</span><span class='line'>chmod g+x /usr/lib/rstudio-server/bin/rsession-mpiexec.sh
</span><span class='line'>chmod o+x /usr/lib/rstudio-server/bin/rsession-mpiexec.sh
</span></code></pre></td></tr></table></div></figure>


<p>Create or modify <em>/etc/rstudio/rserver.conf</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>rsession-path=/usr/lib/rstudio-server/bin/rsession-mpiexec.sh
</span><span class='line'>#rsession-path=/usr/lib/rstudio-server/bin/rsession
</span></code></pre></td></tr></table></div></figure>


<p>Modify <em>/etc/apparmor.d/rstudio-server</em>:</p>

<figure class='code'><figcaption><span>rstudio-server</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>  #/usr/lib/rstudio-server/bin/rsession ux,
</span><span class='line'>  /usr/lib/rstudio-server/bin/rsession-mpiexec.sh ux,
</span></code></pre></td></tr></table></div></figure>


<p>Restart Rstudio Server or restart the Rmaster</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rstudio-server restart
</span></code></pre></td></tr></table></div></figure>


<h3>Testing with <em>Rmpi</em></h3>

<p>Login into web interface of Rstudio and execute</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>library<span class="p">(</span>Rmpi<span class="p">)</span>
</span><span class='line'>cl <span class="o">&lt;-</span> mpi.spawn.Rslaves<span class="p">(</span>nslaves<span class="o">=</span><span class="m">6</span><span class="p">)</span>
</span><span class='line'>mpi.close.Rslaves<span class="p">()</span>
</span><span class='line'>mpi.quit<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>You should see the slaves are spawned in different container/machines.</p>

<h3>Testing with <em>snow</em></h3>

<p>Login into web interface of Rstudio and execute</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>library<span class="p">(</span>snow<span class="p">)</span>
</span><span class='line'>cl <span class="o">&lt;-</span> makeMPIcluster<span class="p">(</span>count <span class="o">=</span> <span class="m">18</span><span class="p">)</span>
</span><span class='line'>unlist<span class="p">(</span>clusterEvalQ<span class="p">(</span>cl<span class="p">,</span> system<span class="p">(</span><span class="s">&#39;hostname&#39;</span><span class="p">,</span>intern<span class="o">=</span><span class="kc">TRUE</span><span class="p">)))</span>
</span><span class='line'>stopCluster<span class="p">(</span>cl<span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You should see the hostname of slaves.</p>

<h1>Trouble Shooting:</h1>

<ul>
<li>Check the network environment

<ul>
<li>Is the <em>/etc/hosts</em> correct?</li>
<li>Can <em>ruser</em> ssh to slaves and masters without password prompt?</li>
</ul>
</li>
<li>Check logs:

<ul>
<li>the system log (/var/log/syslog)</li>
<li>mpiexec error log (/tmp/mpiexec.error.log) which is set in <em>/usr/lib/rstudio-server/bin/rsession-mpiexec.sh</em></li>
</ul>
</li>
</ul>


<p>Good Luck!</p>

<h1>Reference</h1>

<ul>
<li><a href="http://sealmemory.blogspot.tw/2012/05/ubuntu-1204-openmpi-cluster.html">海豹雜記: 使用 Ubuntu Linux 12.04 與 OpenMPI 架設 Cluster</a></li>
<li><a href="http://webappl.blogspot.tw/2012/01/install-rmpi-with-mpich2-environment.html">Web Application: Install Rmpi with MPICH2 environment</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/14/r-closure/">R Closure</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-14T22:27:00+08:00" pubdate data-updated="true">Aug 14<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/14/r-closure/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>R 中<em>function</em>也可以是一種物件型態，或稱做叫作<em>closure</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>typeof<span class="p">(</span>rnorm<span class="p">)</span>
</span><span class='line'><span class="go">[1] &quot;closure&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>要比較兩個function物件，則可透過<code>body</code>這個函數：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>body<span class="p">(</span>rnorm<span class="p">)</span> <span class="o">==</span> body<span class="p">(</span>rexp<span class="p">)</span>
</span><span class='line'><span class="go">[1] FALSE</span>
</span><span class='line'><span class="gp">&gt; </span>body<span class="p">(</span>rnorm<span class="p">)</span> <span class="o">==</span> body<span class="p">(</span>temp<span class="p">)</span>
</span><span class='line'><span class="go">[1] TRUE</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/20/latex-in-octopress/">Latex in Octopress</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-20T13:01:00+08:00" pubdate data-updated="true">Jun 20<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/06/20/latex-in-octopress/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>大致上參考<a href="http://chen.yanping.me/cn/blog/2012/03/10/octopress-with-latex/">在Octopress中使用Latex</a>即可。</p>

<h1>安裝</h1>

<ol>
<li>安裝kramdown</li>
</ol>


<figure class='code'><figcaption><span>install-kramdown</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>gem install kramdown
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>修改<code>/source/_includes/custom/head.html</code></li>
</ol>


<figure class='code'><figcaption><span>head.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!-- mathjax config similar to math.stackexchange --&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">tex2jax</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">inlineMath</span><span class="o">:</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;$&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;\\(&quot;</span><span class="p">,</span><span class="s2">&quot;\\)&quot;</span><span class="p">]</span> <span class="p">],</span>
</span><span class='line'>      <span class="nx">processEscapes</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">tex2jax</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">skipTags</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;noscript&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;textarea&#39;</span><span class="p">,</span> <span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Queue</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">all</span> <span class="o">=</span> <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">getAllJax</span><span class="p">(),</span> <span class="nx">i</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">all</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">all</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">SourceElement</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s1">&#39; has-jax&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
</span><span class='line'>   <span class="na">src=</span><span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>使用注意事項</h1>

<ol>
<li>這個是我自己測出來的bug: <em>在latex中的符號 <code>^</code> 之後要接空格才能正常使用</em>。</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/18/cormen-chp6/">Cormen Chp6</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-18T22:53:00+08:00" pubdate data-updated="true">Jun 18<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/06/18/cormen-chp6/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Heapsort</h1>

<h2>6.1 Heaps</h2>

<h3>Heap Introduction</h3>

<ul>
<li>sorts $n$ elements in $O(nlog(n))$</li>
<li>in place
  ps. <em>in place</em> : only used $O(1)$ additional memory to store data</li>
<li>heat property: $$\mbox{Parent[PARENT(i)] } \leq \mbox{ A[i]}$$</li>
</ul>


<h3>Exercise</h3>

<h4>6.1-1</h4>

<p>min: $2 ^ h$<br/>
max: $2 ^ h - 1$</p>

<h4>6.1-2</h4>

<p>Mathematical Induction</p>

<h4>6.1-3</h4>

<p>Trivial</p>

<h4>6.1-4</h4>

<p>Leaf</p>

<h4>6.1-5</h4>

<p>Yes, it is</p>

<h4>6.1-6</h4>

<p>No, $6 &lt; 7$</p>

<h4>6.1-7</h4>

<p>Proof:
$$
\begin{eqnarray}
&amp; &amp; k \mbox{-th element is a leaf iff } 2k > n \newline
&amp;\Rightarrow&amp; k \geq \lfloor n/2 \rfloor + 1
\end{eqnarray}
$$</p>

<h2>6.2 Maintaining the heap property</h2>

<p><code>MaxHeapify(A,i)</code> convert a heap that the subtree rooted at $2 i$ and
$2 i + 1$ are max-heaps, but $A[i]$ might be smaller than one of its
child, thus violating the max-heap property.</p>

<p>The idea is to float-down $A[i]$.</p>

<h3>Exercise</h3>

<h4>6.2-6</h4>

<p>Give a special case such as root 0 and node 1.</p>

<h2>6.3 Building a heap</h2>

<p>Do <code>MaxHeapify(A,i)</code> from the leaf to the root.</p>

<ul>
<li>Initial: leaf is a valid subtree with heap property</li>
<li>Maintain: for each step of heapify, heap property is maintained</li>
<li>Termination:</li>
</ul>


<h3>Exercise</h3>

<h4>6.3-2</h4>

<p>Because <code>MaxHeapify(A,i)</code> needs <code>left(i)</code> and <code>right(i)</code> are subtree
with heap property.</p>

<h2>6.4 The heapsort algorithm</h2>

<h1>My own implementation</h1>

<p>File /home/wush/git-project/octopress-blog/source/downloads/code/cormen/data_structure/Heap.hpp could not be found
File /home/wush/git-project/octopress-blog/source/downloads/code/cormen/sorting/HeapSort.hpp could not be found</p>

<h1>Reference</h1>

<p>See my github repository: <a href="https://github.com/wush978/cormen">cormen</a> for details of the code.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/14/profiling-r-code/">Profiling R Code</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-14T23:29:00+08:00" pubdate data-updated="true">Jun 14<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/06/14/profiling-r-code/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>簡介</h1>

<p>Profiling的意思就是去測量程式中每個函數的執行時間。
根據經驗法則，通常有80%的執行時間耗費在20%的程式碼中！
所以若有提昇執行效能的需求，第一步就是找出跑得慢得程式碼(bottlenecks)，再針對慢得程式碼去做優化。</p>

<h1>介紹</h1>

<p>ps. 以下的程式碼取自<a href="http://www.math.ncu.edu.tw/~chenwc/R_note/reference/debug/Rdebug.pdf">Rdebug</a></p>

<p>考慮以下三個函數：</p>

<figure class='code'><figcaption><span>fun1.R</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>fun1 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  res <span class="o">&lt;-</span> <span class="kc">NULL</span>
</span><span class='line'>  n <span class="o">&lt;-</span> nrow<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>  <span class="kr">for</span><span class="p">(</span>i in <span class="m">1</span>:n<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kr">if</span> <span class="p">(</span>!any<span class="p">(</span>is.na<span class="p">(</span>x<span class="p">[</span>i<span class="p">,])))</span> <span class="p">{</span>
</span><span class='line'>          res <span class="o">&lt;-</span> rbind<span class="p">(</span>res<span class="p">,</span> x<span class="p">[</span>i<span class="p">,])</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  res
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>fun2.R</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>fun2 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  n <span class="o">&lt;-</span> nrow<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>  res <span class="o">&lt;-</span> matrix<span class="p">(</span><span class="m">0</span><span class="p">,</span> n<span class="p">,</span> ncol<span class="p">(</span>x<span class="p">))</span>
</span><span class='line'>  k <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  <span class="kr">for</span><span class="p">(</span>i in <span class="m">1</span>:n<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kr">if</span> <span class="p">(</span>!any<span class="p">(</span>is.na<span class="p">(</span>x<span class="p">[</span>i<span class="p">,])))</span> <span class="p">{</span>
</span><span class='line'>          res<span class="p">[</span>k<span class="p">,]</span> <span class="o">&lt;-</span> x<span class="p">[</span>i<span class="p">,]</span>
</span><span class='line'>          k <span class="o">&lt;-</span> k <span class="o">+</span> <span class="m">1</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  res<span class="p">[</span><span class="m">1</span>:<span class="p">(</span>k<span class="o">-</span><span class="m">1</span><span class="p">),]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>fun3.R</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>fun3 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  omit <span class="o">&lt;-</span> <span class="kc">FALSE</span>
</span><span class='line'>  n <span class="o">&lt;-</span> ncol<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>  <span class="kr">for</span><span class="p">(</span>i in <span class="m">1</span>:n<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      omit <span class="o">&lt;-</span> omit <span class="o">|</span> is.na<span class="p">(</span>x<span class="p">[,</span>i<span class="p">])</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  x<span class="p">[</span>!omit<span class="p">,]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>將上述三個function分別寫成script檔案後，執行：</p>

<figure class='code'><figcaption><span>Rprof-exp-1.R</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>source<span class="p">(</span><span class="s">&#39;fun1.R&#39;</span><span class="p">)</span>
</span><span class='line'>source<span class="p">(</span><span class="s">&#39;fun2.R&#39;</span><span class="p">)</span>
</span><span class='line'>source<span class="p">(</span><span class="s">&#39;fun3.R&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>size.row <span class="o">&lt;-</span> <span class="m">10</span>L<span class="o">^</span><span class="m">5</span>
</span><span class='line'>size.col <span class="o">&lt;-</span> <span class="m">20</span>L
</span><span class='line'>
</span><span class='line'>x <span class="o">=</span> matrix<span class="p">(</span>rnorm<span class="p">(</span>size.row <span class="o">*</span> size.col<span class="p">),</span>size.row<span class="p">,</span>size.col<span class="p">)</span>
</span><span class='line'>x<span class="p">[</span>x <span class="o">&gt;</span> <span class="m">1.5</span><span class="p">]</span> <span class="o">=</span> <span class="kc">NA</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="s">&quot;method1.out&quot;</span><span class="p">)</span>
</span><span class='line'>fun1<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="kc">NULL</span><span class="p">)</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="s">&quot;method2.out&quot;</span><span class="p">)</span>
</span><span class='line'>fun2<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="kc">NULL</span><span class="p">)</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="s">&quot;method3.out&quot;</span><span class="p">)</span>
</span><span class='line'>fun3<span class="p">(</span>x<span class="p">)</span>
</span><span class='line'>Rprof<span class="p">(</span><span class="kc">NULL</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>此時根目錄會有<code>method1.out</code>, <code>method2.out</code>, <code>method3.out</code>等三個檔案。</p>

<p>打開命令列，執行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>R CMD Rprof method1.out
</span><span class='line'>R CMD Rprof method2.out
</span><span class='line'>R CMD Rprof method3.out
</span></code></pre></td></tr></table></div></figure>


<p>以<code>R CMD Rprof method1.out</code>的結果為例：</p>

<pre><code>Each sample represents 0.02 seconds.
Total run time: 168.98 seconds.

Total seconds: time spent in function and callees.
Self seconds: time spent in function alone.

   %       total       %        self
 total    seconds     self    seconds    name
 100.0    168.98       0.4      0.74     fun1
  99.4    167.98      99.4    167.98     rbind
   0.1      0.20       0.1      0.20     any
   0.0      0.04       0.0      0.04     is.na
   0.0      0.02       0.0      0.02     !


   %        self       %      total
  self    seconds    total   seconds    name
  99.4    167.98      99.4    167.98     rbind
   0.4      0.74     100.0    168.98     fun1
   0.1      0.20       0.1      0.20     any
   0.0      0.04       0.0      0.04     is.na
   0.0      0.02       0.0      0.02     !
</code></pre>

<p>這份報告共有兩個表格：</p>

<ul>
<li>表格一：

<ul>
<li><code>fun1</code>(進入到退出之間)總共花了168.98秒，佔總時間的100%，但是本身(扣除可以分割的部份)只花了0.74秒，佔0.4%</li>
<li><code>rbind</code>(進去到退出之間)花了167.98秒，佔總時間的99.4%，但是本身花了167.98秒，佔整體的99.4%</li>
</ul>
</li>
<li>表格二則和表格一類似，只是表格一是依照進入和退出間所佔的時間來排序，而表格二是依照本身的執行時間來排序。</li>
</ul>


<p>由此可知，我們只要能夠針對表格二的前面數列的函數進行優化，就可以大幅度改進程式效能。</p>

<p>接下來看<code>R CMD Rprof method2.out</code>的結果：</p>

<pre><code>Each sample represents 0.02 seconds.
Total run time: 0.58 seconds.

Total seconds: time spent in function and callees.
Self seconds: time spent in function alone.

   %       total       %        self
 total    seconds     self    seconds    name
 100.0      0.58      69.0      0.40     fun2
  13.8      0.08      13.8      0.08     any
  10.3      0.06      10.3      0.06     is.na
   3.4      0.02       3.4      0.02     !
   3.4      0.02       3.4      0.02     matrix


   %        self       %      total
  self    seconds    total   seconds    name
  69.0      0.40     100.0      0.58     fun2
  13.8      0.08      13.8      0.08     any
  10.3      0.06      10.3      0.06     is.na
   3.4      0.02       3.4      0.02     !
   3.4      0.02       3.4      0.02     matrix
</code></pre>

<p>這裡使用<code>matrix</code>來取代<code>rbind</code>之後，剩下效能的瓶頸就落在<code>any</code>上。
所以<code>fun3</code>更進一步的不使用<code>any</code>，得到：</p>

<pre><code>Each sample represents 0.02 seconds.
Total run time: 0.12 seconds.

Total seconds: time spent in function and callee
Self seconds: time spent in function alone.

   %       total       %        self
 total    seconds     self    seconds    name
 100.0      0.12      16.7      0.02     fun3
  66.7      0.08      66.7      0.08     |
  16.7      0.02      16.7      0.02     is.na


   %        self       %      total
  self    seconds    total   seconds    name
  66.7      0.08      66.7      0.08     |
  16.7      0.02     100.0      0.12     fun3
  16.7      0.02      16.7      0.02     is.na
</code></pre>

<p>可以看到效能又好了近5倍(0.12 : 0.58)！</p>

<h1>參考資料</h1>

<ul>
<li><a href="http://www.math.ncu.edu.tw/~chenwc/R_note/reference/debug/Rdebug.pdf">Rdebug</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/14/r-debug/">R Debug</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-14T01:11:00+08:00" pubdate data-updated="true">Jun 14<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/06/14/r-debug/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>簡介</h1>

<p>很少人能夠第一次寫程式就能寫對，就連最專業的程式設計師也會花大把大把的時間在除錯。
所以熟悉除錯的工具也是能夠顯著的提昇寫程式的效率。</p>

<p>其實作者我在寫這篇文章之前也完全沒用過除錯工具！想到又能提昇自己的coding效率又讓我熊熊的燃燒起來！！</p>

<h1>除錯函數</h1>

<p>R 提供了以下的除錯功能:</p>

<ul>
<li><code>traceback</code></li>
<li><code>browser</code></li>
<li><code>debug</code></li>
<li><code>trace</code></li>
</ul>


<p>就讓我來一個個探索吧！</p>

<h2>traceback</h2>

<p>所謂的traceback功能主要的目的，是找出錯誤發生時最後執行的函數：</p>

<figure class='code'><figcaption><span>traceback-example-1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>fail_func1 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>size<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  b <span class="o">&lt;-</span> <span class="m">5</span>
</span><span class='line'>  b <span class="o">&lt;-</span> b <span class="o">+</span> size
</span><span class='line'>  b <span class="o">&lt;-</span> b <span class="o">*</span> <span class="m">2</span>
</span><span class='line'>  b <span class="o">&lt;-</span> b<span class="o">^</span><span class="m">2</span>
</span><span class='line'>  b
</span><span class='line'><span class="p">}</span>
</span><span class='line'>fail_func2 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>size<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  b <span class="o">&lt;-</span> fail_func1<span class="p">(</span>size<span class="p">)</span>
</span><span class='line'>  a <span class="o">&lt;-</span> sample<span class="p">(</span><span class="m">0</span>:<span class="m">1</span><span class="p">,</span>size<span class="p">,</span><span class="kc">FALSE</span><span class="p">)</span>
</span><span class='line'>  a
</span><span class='line'><span class="p">}</span>
</span><span class='line'>fail_func2<span class="p">(</span><span class="m">12</span><span class="p">)</span>
</span><span class='line'>traceback<span class="p">()</span>
</span><span class='line'>fail_func2<span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">)</span>
</span><span class='line'>traceback<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>運行結果：</p>

<figure class='code'><figcaption><span>traceback-example-1-output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>fail_func2<span class="p">(</span><span class="m">12</span><span class="p">)</span>
</span><span class='line'><span class="go">Error in sample(0:1, size, FALSE) : </span>
</span><span class='line'><span class="go">  cannot take a sample larger than the population when &#39;replace = FALSE&#39;</span>
</span><span class='line'><span class="gp">&gt; </span>traceback<span class="p">()</span>
</span><span class='line'><span class="go">2: sample(0:1, size, FALSE) at #3</span>
</span><span class='line'><span class="go">1: fail_func2(12)</span>
</span><span class='line'><span class="gp">&gt; </span>fail_func2<span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">)</span>
</span><span class='line'><span class="go">Error in b + size : non-numeric argument to binary operator</span>
</span><span class='line'><span class="gp">&gt; </span>traceback<span class="p">()</span>
</span><span class='line'><span class="go">2: fail_func1(size) at #2</span>
</span><span class='line'><span class="go">1: fail_func2(&quot;test&quot;)</span>
</span><span class='line'><span class="gp">&gt; </span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看出traceback確實的找出最後一個丟出錯誤的函數。</p>

<h2>browser</h2>

<p>traceback只能指出錯誤的發生處，並不能幫助使用者找出程式的錯誤。
接下來的<code>browser</code>指令則提供互動式的除錯功能：</p>

<ul>
<li>暫停程式碼的執行</li>
<li>讓使用者能察看某個時間點的變數狀態，甚至是修改變數狀態。此時以下的指令變成有特殊意義：

<ul>
<li><code>c</code> 讓程式繼續進行</li>
<li><code>n</code> 執行下一行</li>
<li><code>Q</code> 中斷</li>
</ul>
</li>
<li>繼續執行</li>
</ul>


<p>ps. 如果在中斷期間要查詢名稱為<code>c</code>、<code>n</code>、<code>Q</code>的變數內容，請用<code>print</code>指令。
但是我個人是認為不應該把變數取這類名稱！！</p>

<p>如果運行以下的指令：</p>

<figure class='code'><figcaption><span>browser-example-1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>global_env <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>fail_func1 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>size<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  fail_func1_env <span class="o">&lt;-</span> <span class="m">5</span>
</span><span class='line'>  browser<span class="p">()</span>
</span><span class='line'>  fail_func1_env <span class="o">&lt;-</span> <span class="m">6</span>
</span><span class='line'>  fail_func1_env <span class="o">&lt;-</span> <span class="m">7</span>
</span><span class='line'>  fail_func1_env
</span><span class='line'><span class="p">}</span>
</span><span class='line'>fail_func2 <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>size<span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  fail_func2_env <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  b <span class="o">&lt;-</span> fail_func1<span class="p">(</span>size<span class="p">)</span>
</span><span class='line'>  a <span class="o">&lt;-</span> sample<span class="p">(</span><span class="m">0</span>:<span class="m">1</span><span class="p">,</span>size<span class="p">,</span><span class="kc">FALSE</span><span class="p">)</span>
</span><span class='line'>  a
</span><span class='line'><span class="p">}</span>
</span><span class='line'>fail_func2<span class="p">(</span><span class="m">12</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>應該會看到類似以下的結果：</p>

<figure class='code'><figcaption><span>browser-example-1-output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>fail_func2<span class="p">(</span><span class="m">12</span><span class="p">)</span>
</span><span class='line'><span class="go">Called from: fail_func1(size)</span>
</span><span class='line'><span class="go">Browse[1]&gt; global_env</span>
</span><span class='line'><span class="go">[1] 1</span>
</span><span class='line'><span class="go">Browse[1]&gt; fail_func1_env</span>
</span><span class='line'><span class="go">[1] 5</span>
</span><span class='line'><span class="go">Browse[1]&gt; fail_func2_env</span>
</span><span class='line'><span class="go">Error: object &#39;fail_func2_env&#39; not found</span>
</span><span class='line'><span class="go">Browse[1]&gt; size</span>
</span><span class='line'><span class="go">[1] 12</span>
</span><span class='line'><span class="go">Browse[1]&gt; n</span>
</span><span class='line'><span class="go">debug at #4: fail_func1_env &lt;- 6</span>
</span><span class='line'><span class="go">Browse[2]&gt; fail_func1_env</span>
</span><span class='line'><span class="go">[1] 5</span>
</span><span class='line'><span class="go">Browse[2]&gt; n</span>
</span><span class='line'><span class="go">debug at #5: fail_func1_env &lt;- 7</span>
</span><span class='line'><span class="go">Browse[2]&gt; fail_func1_env</span>
</span><span class='line'><span class="go">[1] 6</span>
</span><span class='line'><span class="go">Browse[2]&gt; n</span>
</span><span class='line'><span class="go">debug at #6: fail_func1_env</span>
</span><span class='line'><span class="go">Browse[2]&gt; fail_func1_env</span>
</span><span class='line'><span class="go">[1] 7 </span>
</span></code></pre></td></tr></table></div></figure>


<p>在程式跑到<code>browser</code>時就暫停了。
因為<code>browser</code>是插入在<code>fail_func1</code>的第二行，所以變數應該和該時間點相同，
值得注意的是此時也只能存取該function environment內的變數</p>

<h2>debug</h2>

<p>我們可以把上一節的<code>browser</code>視為一種<em>中斷點</em>，
而<code>debug</code>函數則可以幫一個函數的每一行加入中斷點。
在對內建函數除錯的時候非常有用：</p>

<figure class='code'><figcaption><span>debug-example-1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>debug<span class="p">(</span>lm<span class="p">)</span>
</span><span class='line'>lm<span class="p">(</span>Sepal.Length~Species<span class="p">,</span>iris<span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>debug-example-1-output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>lm<span class="p">(</span>Sepal.Length~Species<span class="p">,</span>iris<span class="p">)</span>
</span><span class='line'><span class="go">debugging in: lm(Sepal.Length ~ Species, iris)</span>
</span><span class='line'><span class="go">debug: {</span>
</span><span class='line'><span class="go">    ret.x &lt;- x</span>
</span><span class='line'><span class="go">    ret.y &lt;- y</span>
</span><span class='line'><span class="go">... 略 ...</span>
</span><span class='line'><span class="go">    z</span>
</span><span class='line'><span class="go">}</span>
</span><span class='line'><span class="go">Browse[2]&gt; n</span>
</span><span class='line'><span class="go">debug: ret.x &lt;- x</span>
</span><span class='line'><span class="go">Browse[2]&gt; n</span>
</span><span class='line'><span class="go">debug: ret.y &lt;- y</span>
</span><span class='line'><span class="go">Browse[2]&gt; n</span>
</span><span class='line'><span class="go">debug: cl &lt;- match.call()</span>
</span></code></pre></td></tr></table></div></figure>


<p>除錯完畢後可用<code>undebug</code>來將中斷點移除。</p>

<h2>trace</h2>

<p>有時候只是檢視或修改變數並不夠。
<code>trace</code>函數能在除錯時插入程式碼到某個函數，
並在<code>untrace</code>後還原該函數。</p>

<figure class='code'><figcaption><span>str(trace)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>str<span class="p">(</span>trace<span class="p">)</span>
</span><span class='line'><span class="go">function (what, tracer, exit, at, print, signature, where = topenv(parent.frame()), </span>
</span><span class='line'><span class="go">    edit = FALSE)  </span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>what</code>: 要修改的函數名稱</li>
<li><code>tracer</code>: 要插入的函數或expression。<code>trace</code>會在<code>at</code>給的行數之前執行，或是<code>what</code>開始之前執行。</li>
<li><code>exit</code>: 當<code>what</code>結束之後執行的函數或expression</li>
<li><code>at</code>: <code>trace</code>執行的行數。</li>
</ul>


<p>其他的參數請參閱trace的說明。</p>

<p>測試一下：</p>

<figure class='code'><figcaption><span>trace-example-1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>test_func <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">2</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">3</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>trace<span class="p">(</span>test_func<span class="p">,</span> browser<span class="p">,</span> browser<span class="p">)</span>
</span><span class='line'>test_func<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>trace-example-1-output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>test_func<span class="p">()</span>
</span><span class='line'><span class="go">Tracing test_func() on entry </span>
</span><span class='line'><span class="go">Called from: eval(expr, envir, enclos)</span>
</span><span class='line'><span class="go">Browse[1]&gt; a</span>
</span><span class='line'><span class="go">Error: object &#39;a&#39; not found</span>
</span><span class='line'><span class="go">Browse[1]&gt; c</span>
</span><span class='line'><span class="go">Tracing test_func() on exit </span>
</span><span class='line'><span class="go">Called from: eval(expr, envir, enclos)</span>
</span><span class='line'><span class="go">Browse[1]&gt; a</span>
</span><span class='line'><span class="go">[1] 3</span>
</span><span class='line'><span class="go">Browse[1]&gt; c</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到第一次browser是在執行test_func之前，所以<code>a</code>不存在。
第二次則是離開的時候，所以<code>a</code>為<code>3</code>。</p>

<figure class='code'><figcaption><span>trace-example-2</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>test_func <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">1</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">2</span>
</span><span class='line'>  a <span class="o">&lt;-</span> <span class="m">3</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>trace<span class="p">(</span>test_func<span class="p">,</span> quote<span class="p">(</span>print<span class="p">(</span>a<span class="p">)),</span> at<span class="o">=</span><span class="m">3</span>:<span class="m">4</span><span class="p">)</span> <span class="c1">#利用quote直接插入print(a)到程式中</span>
</span><span class='line'>body<span class="p">(</span>test_func<span class="p">)</span>
</span><span class='line'>test_func<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>trace-example-2-output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='rconsole'><span class='line'><span class="gp">&gt; </span>body<span class="p">(</span>test_func<span class="p">)</span>
</span><span class='line'><span class="go">{</span>
</span><span class='line'><span class="go">    a &lt;- 1</span>
</span><span class='line'><span class="go">    {</span>
</span><span class='line'><span class="go">        .doTrace(print(a), &quot;step 3&quot;)</span>
</span><span class='line'><span class="go">        a &lt;- 2</span>
</span><span class='line'><span class="go">    }</span>
</span><span class='line'><span class="go">    {</span>
</span><span class='line'><span class="go">        .doTrace(print(a), &quot;step 4&quot;)</span>
</span><span class='line'><span class="go">        a &lt;- 3</span>
</span><span class='line'><span class="go">    }</span>
</span><span class='line'><span class="go">}</span>
</span><span class='line'><span class="gp">&gt; </span>test_func<span class="p">()</span>
</span><span class='line'><span class="go">Tracing test_func() step 3 </span>
</span><span class='line'><span class="go">[1] 1</span>
</span><span class='line'><span class="go">Tracing test_func() step 4 </span>
</span><span class='line'><span class="go">[1] 2</span>
</span><span class='line'><span class="gp">&gt; </span>
</span></code></pre></td></tr></table></div></figure>


<p>搭配quote使用可以直接更改function的程式碼，好用好用！
注意at參數所代表的位置！！(讓我滿意外的)</p>

<h1>Reference</h1>

<p><a href="http://www.math.ncu.edu.tw/~chenwc/R_note/reference/debug/Rdebug.pdf">Rdebug</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/08/30/initialize-postgresql/">Initialize PostgreSQL in Ubuntu 12.04</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/30/benchmark-of-saving-and-loading-r-objects/">Benchmark of Saving and Loading R Objects</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/24/pros-and-cons-of-virtualized-system/">我喜歡使用虛擬化系統</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/21/rcpparmadillo/">RcppArmadillo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/16/proxmox-and-r-cluster/">Proxmox &amp; R cluster</a>
      </li>
    
  </ul>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Wush978 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'wush978';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
